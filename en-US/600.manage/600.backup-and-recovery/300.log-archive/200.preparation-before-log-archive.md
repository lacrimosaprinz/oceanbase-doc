|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# Preparations

This topic describes the preparations for log archiving.

## (Optional) Configure the log archiving concurrency

Before you enable the archiving mode for a tenant, you can configure the log archiving concurrency to accelerate log archiving for the tenant.

1. Log on to the database as an administrator of the `sys` tenant or a user tenant.

2. Configure the `log_archive_concurrency` parameter by using a proper statement.

   The tenant-level parameter `log_archive_concurrency` specifies the total number of worker threads for log archiving. The modification of this parameter takes effect immediately without restarting the OBServer node. The value range of this parameter is [0, 100]. The default value is `0`, which means using the adaptive log archiving concurrency of OceanBase Database. We recommend that you use the default value.

   <main id="notice" type='notice'>
   <h4>Notice</h4>
   <p>If the tenant is configured with two or four CPU cores, we recommend that you retain the default value of this parameter. </p>
   </main>

   Methods for adjusting the log archiving concurrency are as follows:

   * Execute the following statement in the `sys` tenant to adjust the log archiving concurrency of a specified tenant:

      ```sql
      ALTER SYSTEM SET log_archive_concurrency = 10 TENANT = mysql_tenant;
      ```

   * Execute the following statement in the `sys` tenant to adjust the log archiving concurrency of all tenants:

      ```sql
      ALTER SYSTEM SET log_archive_concurrency = 10 TENANT = all_user;
      ```

      or

      ```sql
      ALTER SYSTEM SET log_archive_concurrency = 10 TENANT = all;
      ```

     <main id="notice" type='explain'>
     <h4>Note</h4>
     <p>Starting from OceanBase Database V4.2.1, <code>TENANT = all_user</code> and <code>TENANT = all</code> express the same semantics. If you want an operation to take effect on all user tenants, we recommend that you use <code>TENANT = all_user</code>. <code>TENANT = all</code> will be deprecated. </p>

   * Execute the following statement in a user tenant to adjust its log archiving concurrency:

      ```sql
      ALTER SYSTEM SET log_archive_concurrency = 10;
      ```

   For more information about the `log_archive_concurrency` parameter, see [log_archive_concurrency](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/25000.log_archive_concurrency.md).

## Configure the archive destination

Before you initiate a log archiving job, you must execute the `ALTER SYSTEM` statement to configure the `LOG_ARCHIVE_DEST` parameter. The `sys` tenant is used for managing clusters and does not contain user data or support backup or restore. Therefore, you do not need to configure an archive destination for the `sys` tenant.

Set the `LOCATION`, `PIECE_SWITCH_INTERVAL`, and `BINDING` attributes of the archive destination.

### Considerations

When you configure the archive destination, make sure that the archive path for each tenant is set to a unique empty directory. Different tenants cannot be configured with the same archive path.

### Procedure

1. Log on to the database as an administrator of the `sys` tenant or a user tenant.

   <main id="notice" type='explain'>
   <h4>Note</h4>
   <p>The administrator user of a MySQL tenant is <code>root</code> and that of an Oracle tenant is <code>SYS</code>. </p>
   </main>

2. Configure the archive destination.

   * Configure the archive destination for a specified tenant in the `sys` tenant:

      ```sql
      ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=archive_path [PIECE_SWITCH_INTERVAL=archive_mode] [BINDING=piece_switch_interval]' TENANT = tenant_name;
      ```

   * Configure the archive destination for a user tenant from the current tenant:

      ```sql
      ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=archive_path [PIECE_SWITCH_INTERVAL=archive_mode] [BINDING=piece_switch_interval]';
      ```

   <main id="notice" type='notice'>
   <h4>Notice</h4>
   <p>After upgrading OceanBase Database from V4.0.x to V4.1.0, it is necessary to change the archive path. However, when upgrading from V4.1.x to V4.2.1, there is no need to modify the archive path. Moreover, during the upgrade process from V4.1.x to V4.2.1, you have the option to archive logs.</p>
   </main>
   <!-- 待确认：to V4.2.1 or V4.2.0 or V4.2.x? -->

   The details are as follows:

   * (Required) Set `LOCATION`.

      The `LOCATION` attribute specifies the archive destination. OceanBase Database supports three types of media as the archive destination: Network File System (NFS), Alibaba Cloud Object Storage Service (OSS), and Tencent Cloud Object Storage (COS).

      * NFS

         <main id="notice" type='notice'>
         <h4>Notice</h4>
         <p>When you use NFS as the archive destination, note that:</p>
         <ul>
         <li>The value of <code>LOCATION</code> cannot be a string with a question mark (?). </li>
         <li>The value of <code>LOCATION</code> must be an absolute path, and the OBServer node must have read and write privileges on the destination specified by <code>LOCATION</code>. </li>
         <li>Ensure that all OBServer nodes are mounted to NFS of the same server and use the parameter settings recommended in this topic. For more information about the procedure of deploying NFS, see <a href="../200.deploy-nfs.md">Deploy NFS</a>. </li>
         </ul>
         </main>

         When using NFS as the archive medium, you can configure the archive path for a specified tenant `mysql_tenant` from the sys tenant as follows:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive' TENANT = mysql_tenant;
         ```

         When using NFS as the archive medium, you can configure the archive path for for a user tenant from the current tenant as follows:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive';
         ```

         In the examples above, `file://` specifies that NFS is used as the media for the archive destination, and the archive path is `/data/nfs/backup/archive`.

      * OSS

         When you use OSS as the archive destination, besides the archive path and the `host`, `access_key`, and `access_id` parameters, you can also set the `delete_mode` parameter to configure the cleanup mode for archived files.

         The `delete_mode` parameter has two values: `delete` and `tagging`. If you do not specify this parameter, the default value `delete` takes effect.

         * `delete`: Archived files that meet the cleanup requirements are directly deleted.

            In this mode, when you enable automatic cleanup for archived files in automatic mode, the system directly deletes the archived files that meet the requirements.

            <main id="notice" type='notice'>
                <h4>Notice</h4>
                <p>This is the default cleanup mode. If you do not specify <code>delete_mode</code>, the default cleanup mode <code>delete</code> takes effect. </p>
                </main>

         * `tagging`: The archived files that meet the cleanup requirements are tagged and retained.

            In this mode, when you enable automatic cleanup for archived files, the system directly tags the archived files that meet the cleanup requirements. The key of the tag is `delete_mode` and the value is `tagging`. In this way, you can manage the lifecycle of these files on OSS based on the tags.

         When using OSS as the archive medium, you can configure the archive path and the `tagging` cleanup mode for a specified tenant `mysql_tenant` from the sys tenant as follows:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=xxx.aliyun-inc.com&access_id=xxx&access_key=xxx&delete_mode=tagging' TENANT = mysql_tenant;
         ```

         When using OSS as the archive medium, you can configure the archive path and the `tagging` cleanup mode for a user tenant from the current tenant as follows:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=oss://oceanbase-test-bucket/backup/archive?host=xxx.aliyun-inc.com&access_id=xxx&access_key=xxx&delete_mode=tagging';
         ```

         In the examples above, `oss://` specifies that OSS is the archive destination. The storage bucket is named `oceanbase-test-bucket`. The path in the storage bucket is `/backup/archive`. The question mark (`?`) is used to  separate other parameters of the path. The `host` parameter specifies the host address of the storage bucket. The `access_id` and `access_key` parameters specify the access key of OSS. The cleanup mode is set to `tagging`.

         For more information about the automatic cleanup of archived data in `delete` or `tagging` mode, see [Automatically clean up expired backup data](../500.clear-backup-data/100.cleaning-up-backed-up-data-automatically.md).

      * COS

         <main id="notice" type='notice'>
         <h4>Notice</h4>
         <p>If you use COS as the archive destination, you must disable the list cache for buckets. Otherwise, backup data consistency errors may occur. For guidance on how to disable the list cache of a bucket, contact the technical support of COS. </p>
         </main>

         Like OSS, COS also allows you to configure the cleanup mode of archive files by using the `delete_mode` parameter in the same way as with OSS.

         When using COS as the archive medium, you can configure the archive path and the `tagging` cleanup mode for a specified tenant `mysql_tenant` from the sys tenant as follows:

         ```sql
         obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=cos://oceanbase-test-appid/backup/archive?host=cos.ap-xxxx.myqcloud.com&access_id=xxx&access_key=xxx&appid=xxx&delete_mode=tagging' TENANT = mysql_tenant;
         ```

         When using COS as the archive medium, you can configure the archive path and the `tagging` cleanup mode for a user tenant from the current tenant as follows:

         ```sql
         obclient> ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=cos://oceanbase-test-appid/backup/archive?host=cos.ap-xxxx.myqcloud.com&access_id=xxx&access_key=xxx&appid=xxx&delete_mode=tagging';
         ```

         In the examples above, `cos://` specifies that COS is the archive destination. The storage bucket is named `oceanbase-test-appid`. The path in the storage bucket is `/backup/archive`. The question mark (`?`) is used to separate other parameters of the path. The `host` parameter specifies the host address of the storage bucket. The `access_id` and `access_key` parameters specify the access key of COS. The `appid` parameter, which is required, specifies the application ID of the COS account. The cleanup mode is set to `tagging`.

   * (Optional) Set the `BINDING` attribute.

      The `BINDING` attribute specifies the prioritizing mode for archiving and businesses. The `BINDING` attribute has two values: `Optional` and `Mandatory`. If you do not specify this attribute, the default value `Optional` takes effect.

      * The `Optional` mode prioritizes user businesses. In this mode, when log archiving falls behind log generation, logs may be recycled before being archived. This causes an interruption.

      * The `Mandatory` mode prioritizes archiving. In this mode, you may be unable to write more data before existing data is archived.

        When using NFS as the archive medium, you can configure the archive path and the `BINDING` attribute for a specified tenant `mysql_tenant` from the sys tenant as follows:

        ```sql
        ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional' TENANT = mysql_tenant;
        ```

        When using NFS as the archive medium, you can configure the archive path and the `BINDING` attribute for a user tenant from the current tenant as follows:

        ```sql
        ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional';
        ```

   * (Optional) Set the `PIECE_SWITCH_INTERVAL` attribute.

      The `PIECE_SWITCH_INTERVAL` attribute specifies the switching interval for pieces. The value range is `[1d, 7d]`. If you do not specify this attribute, the default value `1d` takes effect.

        When using NFS as the archive medium, you can configure the archive path and split a log piece every other day for a specified tenant `mysql_tenant` from the sys tenant as follows:

        ```sql
        ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional PIECE_SWITCH_INTERVAL=1d' TENANT = mysql_tenant;
        ```

        When using NFS as the archive medium, you can configure the archive path and split a log piece every other day for a user tenant from the current tenant as follows:

        ```sql
        ALTER SYSTEM SET LOG_ARCHIVE_DEST='LOCATION=file:///data/nfs/backup/archive BINDING=Optional PIECE_SWITCH_INTERVAL=1d';
        ```

3. After the configuration is successful, you can query detailed parameter settings through a view.
   
   The `sys` tenant can use the `CDB_OB_ARCHIVE_DEST` view to query parameter settings, while the user tenant can use the `DBA_OB_ARCHIVE_DEST` view for the same purpose. For detailed instructions on viewing the parameter settings, see [View archiving parameter settings](../300.log-archive/800.view-parameters-of-log-archive.md).

### Considerations

After you configure the `LOG_ARCHIVE_DEST` parameter, by default, the system creates a file named `format` in the directory to which the specified destination belongs. This file is used to verify the validity information of the archive destination and ensure the integrity of data in the destination. Therefore, note the following when you configure the log archive destination:

* If the `format` file does not exist, the directory where the configured destination is located must be empty so that the `LOG_ARCHIVE_DEST` parameter can be set. If this directory is not empty, the system returns the `-9080` error to indicate that the `format` file does not exist.

* If the `format` file exists, its content must be verified so that the parameter can be set. Otherwise, the system returns the `-9081` error to indicate that the `format` file does not match. The content of the `format` file is verified to check whether the types of the cluster, tenant, and backup destination in the file match those of the current cluster, tenant, and backup destination.

* When you execute a backup job, the job fails to be initiated if the `format` file does not exist or fails the verification.

In addition, incremental configuration is not supported after the archive destination is configured. Assume that the `BINDING` attribute is set to `Mandatory` and the `PIECE_SWITCH_INTERVAL` attribute is set to `1d` for the archive path `/data/nfs/backup/archive` in NFS. To change the value of `PIECE_SWITCH_INTERVAL` to `2d` and keep the setting of the `BINDING` attribute to `Mandatory`, you still need to specify the values of other attributes in the statement. If you do not specify a value for an attribute, the default value is used for the attribute.

Execute the following statement to modify the attribute settings:

* Modify the attribute settings for a specified tenant from the sys tenant:

  ```sql
  ALTER SYSTEM SET LOG_ARCHIVE_DEST = 'LOCATION=file:///data/nfs/backup/archive BINDING=Mandatory PIECE_SWITCH_INTERVAL=2d' TENANT = mysql_tenant;
  ```

* Modify the attribute settings for a user tenant from the current tenant:

  ```sql
  ALTER SYSTEM SET LOG_ARCHIVE_DEST = 'LOCATION=file:///data/nfs/backup/archive BINDING=Mandatory PIECE_SWITCH_INTERVAL=2d';
  ```

## (Optional) Set the archiving status of the archive destination

By default, the archiving status of a newly configured archive destination is `ENABLE`. You can query the `DBA_OB_ARCHIVE_DEST` view for the archiving status of the archive destination. For more information, see [View the archiving parameter settings](../300.log-archive/800.view-parameters-of-log-archive.md). If `ARCHIVELOG` has been enabled for this tenant, the system automatically triggers an archiving job to archive logs to the specified path of the destination.

The following table describes the archiving status of the archive destination.

| State | Description |
|-------------|-------------------------------------------------------------------------|
| ENABLE | Archiving is enabled at the archive destination. If no archiving job is initiated, the system will initiate an archiving job.  |
| DEFER | Archiving is stopped at the archive destination. If an archiving job is in progress, the system will stop the archiving job.  |

Perform the following steps to set the archiving status of the archive destination to `DEFER` or `ENABLE` based on the actual situation.

1. Log on to the database as an administrator of the `sys` tenant or a user tenant.

   <main id="notice" type='explain'>
   <h4>Note</h4>
   <p>The administrator user of a MySQL tenant is <code>root</code> and that of an Oracle tenant is <code>SYS</code>. </p>
   </main>

2. Enable or disable archiving at the archive destination based on the actual situation.

   * Enable archiving at the archive destination.

      * Enable archiving for a specified tenant from the `sys` tenant:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE='ENABLE' TENANT = tenant_name;
         ```

      * Enable archiving for a user tenant from the current tenant:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE='ENABLE';
         ```

      After archiving is enabled at the archive destination, an archiving job will be triggered after `ARCHIVELOG` is enabled for the tenant, to archive logs to the specified path of the destination. If `ARCHIVELOG` has been enabled for the tenant, an archiving job is automatically triggered.

   * Disable archiving at the archive destination.

      * Disable archiving for a specified tenant from the `sys` tenant:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE='DEFER' TENANT = tenant_name;
         ```

      * Disable archiving for a user tenant from the current tenant:

         ```sql
         ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE='DEFER';
         ```

      After archiving is disabled at the archive destination, the ongoing archiving job will be suspended. You can set the archiving status of the archive destination to `ENABLE` to resume the archiving job.

## References

* [View the archiving parameter settings](../300.log-archive/800.view-parameters-of-log-archive.md)

* [View the archiving progress](../300.log-archive/600.view-log-archive-progress.md)

* [View the archiving history](../300.log-archive/700.view-log-archive-history.md)
