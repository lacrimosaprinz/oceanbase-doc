# Backup directory structures

## Structure of the log archive directory

You can specify the time interval for splitting the log archive directory. By default, the directory is split by day. In other words, the log data directory of one day corresponds to a `backup_piece`. A `backup_piece` directory contains a `single_piece_info` file, which records the `backup_piece` information, and a `tenant_backup_piece_infos` file, which records the information about all `backup_pieces` of the tenant.

`rounds` in the log archive directory is a placeholder for log archiving. Each placeholder indicates the start and end of a log round. A placeholder is in the format of `round_DSETID_ROUNDID_STATE`, where:

* `DSETID` indicates the ID of the archive path.

* `ROUNDID` indicates the round of log archiving.

* `STATE` indicates the start or end of the log round.

`pieces` in the log archive directory is a placeholder for log archiving. Each placeholder indicates the start and end of a log piece. A placeholder is in the format of `piece_DSETID_ROUNDID_PIECEID_STATE_DATE`, where:

* `DSETID` indicates the ID of the archive path.

* `ROUNDID` indicates the round of log archiving.

* `PIECEID` indicates the ID of the log piece.

* `STATE` indicates the start or end of the log round.

* `DATE` indicates the backup time. The value is in the format of `yyyymmddThhmmss`. It records the start or end time.

For backup media such as NFS, OSS, and COS, the directory structure for log archiving is as follows:


```javascript
log_archive_dest
    ├── check_file
    │   └── 1002_connect_file_20230111T193049.obbak // The connectivity check file.
    ├── format.obbak                                // The format information of the backup path.
    ├── rounds                                      // The rounds placeholder directory.
    │   └── round_d1002r1_start.obarc               // The placeholder indicating that a round starts.
    ├── pieces                                      // The piece placeholder directory.
    │   ├── piece_d1002r1p1_start_20230111T193049.obarc // The placeholder indicating that a piece starts, in the format of piece_DESTID_ROUNDID_PIECEID_DATE_start.
    │   └── piece_d1002r1p1_end_20230111T193249.obarc   // The placeholder indicating that a piece ends, in the format of piece_DESTID_ROUNDID_PIECEID_DATE_end.
    └── piece_d1002r1p1                             // The piece directory, which is in the format of piece_DESTID_ROUNDID_PIECEID.       
        ├── piece_d1002r1p1_20230111T193049_20230111T193249.obarc // Records the continuous interval of the piece.
        ├── checkpoint   
        │   └── checkpoint_info.0.obarc             // Records the archiving progress of the piece. Only the piece being archived is recorded.
        ├── single_piece_info.obarc                 // Records the metadata of the piece.
        ├── tenant_archive_piece_infos.obarc        // Records the metadata of all frozen pieces before this piece.      
        ├── file_info.obarc                         // List of all log stream files.
        ├── logstream_1                             // Log stream 1.
        │   ├── file_info.obarc                    // File list for log stream 1.
        │   ├── log
        │   │   └── 1.obarc                         // Archive file under log stream 1.
        │   └── schema_meta                         // Records metadata of the data dictionary. This file is only generated in log stream 1.
        │       └── 1677588501408765915.obarc                           
        └── logstream_1001                          // Log stream 1001.
            ├── file_info.obarc                      // File list for log stream 1001.
            └── log
                └── 1.obarc                          // Archive file for log stream 1001.
```

In the above directory structure, the top-level directory contains the following three types of data:

* `format.obbak` and `check_file`: Used for connectivity checks for the user log archive directory.

* `rounds`: Summarizes the rounds of log archiving, recording the list of all rounds.

* `pieces`: Summarizes the pieces of log archiving, recording the list of all pieces.

* `piece_d1002r1p1`: The directory for log archiving pieces, with a naming format of `piece_DESTID_ROUNDID_PIECEID`. Here, `DESTID` refers to the ID corresponding to `log_archive_dest`; `ROUNDID` refers to the ID of the log archiving Round, which is a monotonically increasing integer; and `PIECEID` refers to the ID of the log archiving piece, also a monotonically increasing integer.

  In a log archiving piece directory, the following data is included:

  * `piece_d1002r1p1_20230111T193049_20230111T193249.obarc`: This file displays the current piece's ID, start and end times, and is only used for informational purposes.

  * `checkpoint`: This directory is the active piece's record of the archiving checkpoint, and the ObArchiveScheduler module regularly updates the checkpoint information in this directory.

  * `single_piece_info.obarc`: This file records the metadata of the current piece.

  * `tenant_archive_piece_infos.obarc`: This file records the metadata of all frozen pieces within the current tenant.
  
  * `file_info.obarc`: This file records the list of log streams within the piece.

  * `logstream_1`: This directory records the log files of log stream 1, which is the system log stream of the OceanBase tenant.

  * `logstream_1001`: This directory records the log files of log stream 1001, where log streams with an ID greater than 1000 are user log streams of the OceanBase tenant.

  At the same time, each log stream backup contains three types of data:

  * `file_info.obarc`: This file records the list of files within the log stream.
  
  * `log`: This directory contains all the archived files of the current log stream, with file names consistent with the internal log files of the source cluster.

  * `schema_meta`: This directory records the metadata of the data dictionary, only present in the system log stream, and is not present in user log streams.

For S3, the directory structure for log archiving is different from other media, as each individual archive file is composed of multiple small files and corresponding metadata files, with the specific directory structure as follows.

<main id="notice" type='explain'>
<h4>Note</h4>
<p>Although the directory structure for log archiving in S3 differs from that of backup media such as NFS, OSS, and COS, backup files on S3 can still be restored after being copied to other backup media across clouds. For example, by copying archived data from S3 to OSS and using the OSS path, successful recovery is still possible.</p>
</main>


```javascript
log_archive_dest
    ├── ......                                   
    └── piece_d1002r1p1                             // The piece directory, with a naming format of piece_DESTID_ROUNDID_PIECEID.
        ├── ......                         					// List of all log stream files.
        ├── logstream_1                             // Log stream 1.
        │   ├── file_info.obarc                    // File list for log stream 1.
        │   ├── log
        │   │   └── 1.obarc                         // The archive file under log stream 1, marked by a prefix.  
        |		|       └── @APD_PART@0-32472973.obarc  // The actual data within the archive file, recording data from bytes 0 to 32472973 of the log file.
        |		|		    └── ......  
        |		|		    └── @APD_PART@FORMAT_META.obarc // The archive file format.
        |		|		    └── @APD_PART@SEAL_META.obarc   // The metadata information of the archive file.      
        │   └── schema_meta                         // Records metadata of the data dictionary, only present in log stream 1.
        │       └── 1677588501408765915.obarc                           
        └── logstream_1001                          // Log stream 1001.
            ├── file_info.obarc                      // File list for log stream 1001.
            └── log
                └── 1.obarc                          // Archive file for log stream 1001.     
```

In the above log archiving directory, `1.obarc` represents a single archive file, which is identified by a prefix that matches the archive file name. Each individual archive file mainly contains the following three types of data:

* `@APD_PART@FORMAT_META.obarc`: When writing to the archive file for the first time, the `format_meta` file is written in this directory to record the format of the archive file.

* `@APD_PART@0-32472973.obarc`: The actual data within the archive file is written to a file named with this prefix, and each write operation records the start and end offsets in the file name.

* `@APD_PART@SEAL_META.obarc`: After the final write operation to the archive file, the `seal_meta` file is generated in this directory to record the metadata of the archive file.

## Structure of the data backup directory

A single data backup corresponds to a backup_set. Every time the user runs `ALTER SYSTEM BACKUP DATABASE`, a new directory for the backup_set is created, containing all the data for the current backup.

The directory structure for data backup is as follows:

```javascript
data_backup_dest
├── format.obbak                                            // The format information of the backup path.
├── check_file
│   └── 1002_connect_file_20230111T193020.obbak             // The connectivity check file.
├── backup_sets                                             // The summary directory of the data backup list, recording all the data backup sets.
│   ├── backup_set_1_full_end_success_20230111T193420.obbak // The full backup end placeholder.
│   ├── backup_set_1_full_start.obbak                       // The full backup start placeholder.
│   ├── backup_set_2_inc_start.obbak                        // The incremental backup start placeholder.
│   └── backup_set_2_inc_end_success_20230111T194420.obbak  // The incremental backup end placeholder.
└── backup_set_1_full                                        // The full backup set. Files ending with full indicate a full backup, and inc indicates an incremental backup.
    ├── backup_set_1_full_20230111T193330_20230111T193420.obbak //The placeholder that displays the start and end time of the full backup.
    ├── single_backup_set_info.obbak                        // The metadata of the current backup set.
    ├── tenant_backup_set_infos.obbak                       // The information of the current tenant's full backup set.
    ├── infos
    │   ├── major_data_info_turn_1                           // Tenant-level backup files under major turn 1.
    │   │   ├── tablet_log_stream_info.obbak                 // The mapping file for tablet and log stream. 
    │   │   ├── tenant_major_data_macro_range_index.0.obbak  // The major macro block index.
    │   │   ├── tenant_major_data_meta_index.0.obbak         // The major meta index.
    │   │   └── tenant_major_data_sec_meta_index.0.obbak     // The mapping file for major logical ID and physical ID.
    │   ├── minor_data_info_turn_1                           // Tenant-level backup files under minor turn 1.
    │   │   ├── tablet_log_stream_info.obbak                 // The mapping file for tablet and log stream.
    │   │   ├── tenant_minor_data_macro_range_index.0.obbak  // The minor macro block index.
    │   │   ├── tenant_minor_data_meta_index.0.obbak         // The minor meta index.
    │   │   └── tenant_minor_data_sec_meta_index.0.obbak     // The mapping for minor logical ID and physical ID.
    │   ├── diagnose_info.obbak                              // The backup set diagnostic information file.
    │   ├── locality_info.obbak                              // The locality information of the current backup set's tenant.
    │   └── meta_info                                        // The log stream metadata file at the tenant level, containing metadata of all log streams.
    │       ├── ls_attr_info.1.obbak                         // The snapshot of the log stream list during backup.
    │       └── ls_meta_infos.obbak                          // The meta collection of all log streams.
    ├── logstream_1                                          // Log stream 1.
    │   ├── major_data_turn_1_retry_0                        // Baseline data under turn 1, retry 0.
    │   │   ├── macro_block_data.0.obbak                     // A data file, with a size of 512 MB to 4 GB.
    │   │   ├── macro_range_index.obbak                      // The macro index.
    │   │   ├── meta_index.obbak                             // The meta index.
    │   │   └── sec_meta_index.obbak                         // The mapping file for logical ID and physical ID.
    │   ├── meta_info_turn_1_retry_0                         // The log stream metadata file under turn 1, retry 0.
    │   │   ├── ls_meta_info.obbak                           // The log stream metadata.
    │   │   └── tablet_info.1.obbak                          // The log stream tablet metadata list.
    │   ├── minor_data_turn_1_retry_0                        // The dump data under turn 1, retry 0.
    │   │   ├── macro_block_data.0.obbak
    │   │   ├── macro_range_index.obbak
    │   │   ├── meta_index.obbak
    │   │   └── sec_meta_index.obbak
    │   └── sys_data_turn_1_retry_0                          // The system tablet data under turn 1, retry 0.
    │       ├── macro_block_data.0.obbak
    │       ├── macro_range_index.obbak
    │       ├── meta_index.obbak
    │       └── sec_meta_index.obbak
    └── logstream_1001                                       // Log stream 1001.
        ├── major_data_turn_1_retry_0
        │   ├── macro_block_data.0.obbak
        │   ├── macro_range_index.obbak
        │   ├── meta_index.obbak
        │   └── sec_meta_index.obbak
        ├── meta_info_turn_1_retry_0
        │   ├── ls_meta_info.obbak
        │   └── tablet_info.1.obbak
        ├── minor_data_turn_1_retry_0
        │   ├── macro_block_data.0.obbak
        │   ├── macro_range_index.obbak
        │   ├── meta_index.obbak
        │   └── sec_meta_index.obbak
        └── sys_data_turn_1_retry_0
            ├── macro_block_data.0.obbak
            ├── macro_range_index.obbak
            ├── meta_index.obbak
            └── sec_meta_index.obbak
```

In the backup directory structure, the top-level directory contains the following three types of data:

* `format.obbak` and `check_file`: Used for connectivity checks for the user log archive directory.

* `backup_sets`: The summary directory of the data backup list, recording all the data backup sets.

* `backup_set_1_full`: This directory represents a data backup set. The directory name ending in `full` indicates a full backup, and `inc` indicates an incremental backup. Each data backup generates a corresponding backup set, and once the data backup is complete, the backup set will no longer be modified.

  In a data backup set, the following data is included:

  * `backup_set_1_full_20230111T193330_20230111T193420.obbak`: This file displays the current backup set's ID, start and end times, and is only used for informational purposes.

  * `single_backup_set_info.obbak`: This file records the metadata of the current backup set, including the backup position, and information about any dependent logs.

  * `tenant_backup_set_infos.obbak`: This file records the metadata of all existing backup sets for the current tenant.

  * `infos`: This directory records the metadata of the data backup sets.

  * `logstream_1`: This directory records all the data of log stream 1, which is the system log stream for the OceanBase database tenant.

  * `logstream_1001`: This directory records all the data of log stream 1001, where log streams with IDs greater than 1000 are user log streams for the OceanBase database tenant.

At the same time, each log stream backup also has four types of directories. Directories with `retry` indicate log stream-level retries, while those with `turn` indicate tenant-level retries:

  * `meta_info_xx`: This directory records log stream metadata and tablet metadata.
  * `sys_data_xx`: This directory records the data of internal system Tablets within the log stream.
  * `minor_data_xx`: This directory records the dump data of regular tablets.
  * `major_data_xx`: This directory records the baseline data of regular tablets.