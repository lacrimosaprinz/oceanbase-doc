|description|本文主要介绍 PHP 连接 OceanBase 数据库。|
|---|---|
|keywords||
|dir-name|GORM|
|dir-name-en||
|tenant-type|MySQL Mode|

# PHP 驱动连接  OceanBase 数据库

本文介绍 PHP 驱动连接 OceanBase 数据库示例。

## 适用版本

OceanBase 数据库所有版本。

## 环境安装

执行如下命令安装 PHP。

```sql
sudo yum install php
sudo yum install php-mysql
```

安装成功后返回结果如下：

```sql
Install  1 Package (+9 Dependent packages)

Total download size: 28 M
Installed size: 43 M
Is this ok [y/d/N]: y
Downloading packages:
(1/10): apr-1.4.8-3.1.alios7.x86_64.rpm                                                                       | 102 kB  00:00:00
(2/10): apr-util-1.5.2-6.1.alios7.x86_64.rpm                                                                  |  91 kB  00:00:00
(3/10): httpd-2.4.6-99.1.alios7.1.x86_64.rpm                                                                  | 1.2 MB  00:00:00
(4/10): alios-logos-70.0.6-3.alios7.noarch.rpm                                                                |  21 MB  00:00:00
(5/10): httpd-tools-2.4.6-99.1.alios7.1.x86_64.rpm                                                            |  93 kB  00:00:00
(6/10): mailcap-2.1.41-2.1.alios7.noarch.rpm                                                                  |  30 kB  00:00:00
(7/10): libzip-0.10.1-8.1.alios7.x86_64.rpm                                                                   |  47 kB  00:00:00
(8/10): php-5.4.16-36.1.alios7.x86_64.rpm                                                                     | 1.4 MB  00:00:00
(9/10): php-common-5.4.16-36.1.alios7.x86_64.rpm                                                              | 562 kB  00:00:00
(10/10): php-cli-5.4.16-36.1.alios7.x86_64.rpm                                                                | 2.7 MB  00:00:00
-------------------------------------------------------------------------------------------------------------------------------------Total                                                                                                 24 MB/s |  28 MB  00:00:01
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : apr-1.4.8-3.1.alios7.x86_64                                                                                      1/10
  Installing : apr-util-1.5.2-6.1.alios7.x86_64                                                                                 2/10
  Installing : httpd-tools-2.4.6-99.1.alios7.1.x86_64                                                                           3/10
  Installing : mailcap-2.1.41-2.1.alios7.noarch                                                                                 4/10
  Installing : alios-logos-70.0.6-3.alios7.noarch                                                                               5/10
  Installing : httpd-2.4.6-99.1.alios7.1.x86_64                                                                                 6/10
  Installing : libzip-0.10.1-8.1.alios7.x86_64                                                                                  7/10
  Installing : php-common-5.4.16-36.1.alios7.x86_64                                                                             8/10
  Installing : php-cli-5.4.16-36.1.alios7.x86_64                                                                                9/10
  Installing : php-5.4.16-36.1.alios7.x86_64                                                                                   10/10
  Verifying  : libzip-0.10.1-8.1.alios7.x86_64                                                                                  1/10
  Verifying  : httpd-tools-2.4.6-99.1.alios7.1.x86_64                                                                           2/10
  Verifying  : apr-1.4.8-3.1.alios7.x86_64                                                                                      3/10
  Verifying  : php-common-5.4.16-36.1.alios7.x86_64                                                                             4/10
  Verifying  : httpd-2.4.6-99.1.alios7.1.x86_64                                                                                 5/10
  Verifying  : alios-logos-70.0.6-3.alios7.noarch                                                                               6/10
  Verifying  : apr-util-1.5.2-6.1.alios7.x86_64                                                                                 7/10
  Verifying  : php-cli-5.4.16-36.1.alios7.x86_64                                                                                8/10
  Verifying  : php-5.4.16-36.1.alios7.x86_64                                                                                    9/10
  Verifying  : mailcap-2.1.41-2.1.alios7.noarch                                                                                10/10

Installed:
  php.x86_64 0:5.4.16-36.1.alios7

Dependency Installed:
  alios-logos.noarch 0:70.0.6-3.alios7      apr.x86_64 0:1.4.8-3.1.alios7                 apr-util.x86_64 0:1.5.2-6.1.alios7
  httpd.x86_64 0:2.4.6-99.1.alios7.1        httpd-tools.x86_64 0:2.4.6-99.1.alios7.1      libzip.x86_64 0:0.10.1-8.1.alios7
  mailcap.noarch 0:2.1.41-2.1.alios7        php-cli.x86_64 0:5.4.16-36.1.alios7           php-common.x86_64 0:5.4.16-36.1.alios7

Complete!
```

查看是否安装成功：

```sql
[root]# php -v
PHP 5.4.16 (cli) (built: Dec 13 2015 00:05:14)
Copyright (c) 1997-2013 The PHP Group
Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies
```

## 测试连接 OceanBase

### 使用 ext 或 mysqli 驱动

创建 PHP 连接脚本：

```php
[root]# vim obtest.php
<?php
$servername = "172.30.xxx.xxx";
$port = "2881";
$username = "root@mysql";
$password = "5xx";
$dbname = "test";

// 创建连接
$conn = mysqli_connect($servername, $username, $password, $dbname, $port);

// 检查连接是否成功
if (!$conn) {
    die("连接失败: " . mysqli_connect_error());
}
echo "连接成功";
?>
```

其中：

* `ervername` 是指服务器地址。
* `$username` 指连接数据库的用户名。
* `$password` 是连接数据库的密码。
* `$dbname` 指要连接的数据库名称。

测试故意输入错误密码，会返回如下示例及失败原因：

```shell
[root]# php obtest.php
PHP Warning:  mysqli_connect(): (42000/1045): Access denied for user 'root'@'xxx.xxx.xxx.xxx' (using password: YES) in /home/admin/obtest.php on line 9
连接失败: Access denied for user 'root'@'xxx.xxx.xxx.xxx' (using password: YES)
```

输入正确密码提示连接成功，返回示例如下：

```shell
[root]# php obtest.php
连接成功
```

测试建表及增删改查，测试脚本如下：

```php
[root]# vim obtest.php
<?php
$servername = "172.30.xxx.xxx"; // 服务器地址
$port = "2881";
$username = "root@mysql001"; // 用户名
$password = "_Ocexxxx"; // 密码
$dbname = "test"; // 要连接的数据库名称

// 创建连接
$conn = mysqli_connect($servername, $username, $password, $dbname, $port);

// 检查连接是否成功
if (!$conn) {
    die("连接失败: " . mysqli_connect_error());
}

// 创建表
$sql = "CREATE TABLE MyGuests (
id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
firstname VARCHAR(30) NOT NULL,
lastname VARCHAR(30) NOT NULL,
email VARCHAR(50),
reg_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)";
if (mysqli_query($conn, $sql)) {
    echo "表 MyGuests 创建成功";
} else {
    echo "创建表错误: " . mysqli_error($conn);
}

// 插入数据
$sql = "INSERT INTO MyGuests (firstname, lastname, email)
VALUES ('John', 'Doe', 'john@example.com')";
if (mysqli_query($conn, $sql)) {
    echo "新记录插入成功";
} else {
    echo "插入数据错误: " . mysqli_error($conn);
}
"obtest.php" 62L, 1596C
```

执行成功返回结果如下：

```shell
[root]# php obtest.php
表 MyGuests 创建成功新记录插入成功id: 1 - Name: John Doe<br>表 MyGuests 删除成功
```

### 使用 mysqli 驱动

测试脚本如下：

```shell
[root]# vim obtest.php
<?php
$servername = "11.158.xx.xx";
$port = "6001";
$username = "root@mysql";
$password = "";
$dbname = "test";

// 创建连接
$conn = new mysqli($servername, $username, $password, $dbname, $port);

// 检查连接是否成功
if ($conn->connect_error) {
    die("连接失败: " . $conn->connect_error);
}

// 创建表
$sql = "CREATE TABLE MyGuests (
id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
firstname VARCHAR(30) NOT NULL,
lastname VARCHAR(30) NOT NULL,
email VARCHAR(50),
reg_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)";
if ($conn->query($sql) === TRUE) {
    echo "表 MyGuests 创建成功";
} else {
    echo "创建表错误: " . $conn->error;
}

// 插入数据
$sql = "INSERT INTO MyGuests (firstname, lastname, email)
VALUES ('John', 'Doe', 'john@example.com')";
if ($conn->query($sql) === TRUE) {
    echo "新记录插入成功";
} else {
    echo "插入数据错误: " . $conn->error;
}

// 查询表
$sql = "SELECT id, firstname, lastname FROM MyGuests";
$result = $conn->query($sql);

if ($result->num_rows > 0) {
    // 输出数据
    while($row = $result->fetch_assoc()) {
        echo "id: " . $row["id"]. " - Name: " . $row["firstname"]. " " . $row["lastname"]. "<br>";
    }
} else {
    echo "0 结果";
}

// 删除表
$sql = "DROP TABLE MyGuests";
if ($conn->query($sql) === TRUE) {
    echo "表 MyGuests 删除成功";
} else {
    echo "删除表错误: " . $conn->error;
}

// 关闭连接
$conn->close();
?>
```

其中：

* `$servername` 指的是 MySQL 服务器地址。
* `$port` 指的是 MySQL 服务器端口号。
* `$username` 指的是 MySQL 用户名。
* `$password` 指的是连接 MySQL 的密码。
* `$dbname` 指的是要连接的数据库名称。

返回结果如下：

```shell
[root]# php obtest.php
表 MyGuests 创建成功新记录插入成功id: 1 - Name: John Doe<br>表 MyGuests 删除成功
```

### 使用 PDO 驱动

创建测试脚本：

```shell
[root]# vim podtest.php
<?php
$servername = "172.30.xx.xxx";
$port = "2881";
$username = "root@mysql";
$password = "_Ocexxxx";
$dbname = "test";

// 创建连接
try {
    $conn = new PDO("mysql:host=$servername;port=$port;dbname=$dbname", $username, $password);
    // 设置 PDO 错误模式为异常
    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "连接成功";
} catch(PDOException $e) {
    echo "连接失败: " . $e->getMessage();
}
?>
```

其中：

* `$servername` 指的是 MySQL 服务器地址。
* `$port` 指的是 MySQL 服务器端口号。
* `$username` 指的是 MySQL 用户名。
* `$password` 指的是连接 MySQL 的密码。
* `$dbname` 指的是要连接的数据库名称。

故意填写错误的数据库，会返回如下报错信息：

```shell
[root]# php podtest.php
连接失败: SQLSTATE[42000] [1049] Unknown database 'test123'
```

填写正确的信息，提示连接成功：

```shell
[root]# php podtest.php
连接成功
```

测试建表及增删改查，脚本如下：

```shell
[root]# vim podtest.php
<?php
$servername = "172.30.xxx.xxx"; // MySQL服务器地址
$port = "2881"; // MySQL服务器端口号
$username = "root@mysql"; // MySQL用户名
$password = ""; // MySQL密码
$dbname = "test"; // 要连接的数据库名称

// 创建连接
try {
    $conn = new PDO("mysql:host=$servername;port=$port;dbname=$dbname", $username, $password);
    // 设置 PDO 错误模式为异常
    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "连接成功";
} catch(PDOException $e) {
    echo "连接失败: " . $e->getMessage();
}

// 创建表
try {
    $sql = "CREATE TABLE MyGuests (
    id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    firstname VARCHAR(30) NOT NULL,
    lastname VARCHAR(30) NOT NULL,
    email VARCHAR(50),
    reg_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )";
    $conn->exec($sql);
    echo "表 MyGuests 创建成功";
} catch(PDOException $e) {
    echo "创建表错误: " . $e->getMessage();
}

// 插入数据
try {
    $sql = "INSERT INTO MyGuests (firstname, lastname, email)
    VALUES ('John', 'Doe', 'john@example.com')";
    $conn->exec($sql);
    echo "新记录插入成功";
} catch(PDOException $e) {
    echo "插入数据错误: " . $e->getMessage();
}

// 查询表
try{
    $sql = "SELECT id, firstname, lastname FROM MyGuests";
    $stmt = $conn->prepare($sql);
    $stmt->execute();
    $result = $stmt->setFetchMode(PDO::FETCH_ASSOC);
    if ($stmt->rowCount() > 0) {
        // 输出数据
        while($row = $stmt->fetch()) {
            echo "id: " . $row["id"]. " - Name: " . $row["firstname"]. " " . $row["lastname"]. "<br>";
        }
    } else {
        echo "0 结果";
    }
} catch(PDOException $e) {
    echo "查询表错误: " . $e->getMessage();
}

// 删除表
try {
    $sql = "DROP TABLE MyGuests";
    $conn->exec($sql);
    echo "表 MyGuests 删除成功";
} catch(PDOException $e) {
    echo "删除表错误: " . $e->getMessage();
}

// 关闭连接
$conn = null;
?>
```

脚本执行成功，返回如下示例：

```shell
[root]# php podtest.php
连接成功表 MyGuests 创建成功新记录插入成功id: 1 - Name: John Doe<br>表 MyGuests 删除成功
```
