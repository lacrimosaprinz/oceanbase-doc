|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 创建服务

OceanBase 数据库支持为用户租户创建服务。

## 使用限制

* 不支持为 `sys` 租户或 Meta 租户创建服务。

* 一个用户租户最多只能创建一个 SERVICE_NAME。

## 注意事项

使用 `CREATE SERVICE` 命令为租户创建服务时，需要用户自行保证一个 SERVICE_NAME 下最多只有一个主租户，建议使用 OCP 来维护主备关系并管理服务，有关使用 OCP 管理主备租户的详细介绍及操作，参见 [OCP 官方文档](https://www.oceanbase.com/docs/common-ocp-1000000000826772)。

## 前提条件

* 执行 `CREATE SERVICE` 命令要求用户具有 `ALTER SYSTEM` 权限。

* 为租户创建服务时，要求租户的 `SWITCHOVER_STATUS` 为 `NORMAL`，即保证租户不处于主备角色切换的中间状态。

   查询租户的 `TENANT_ROLE` 和 `SWITCHOVER_STATUS` 的方法如下：

  * 系统租户下查询指定租户的 `TENANT_ROLE` 及 `SWITCHOVER_STATUS`

    ```shell
    obclient [oceanbase]> SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = mysql_tenant;
    ```

  * 用户租户查询本租户的 `TENANT_ROLE` 及 `SWITCHOVER_STATUS`

    ```shell
    obclient [oceanbase]> SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS;
    ```

    ```shell
    obclient [SYS]> SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, SWITCHOVER_STATUS FROM SYS.DBA_OB_TENANTS;
    ```

## 步骤一：确认待创建的 SERVICE_NAME 下的租户

1. 使用 `root` 用户登录集群的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@sys#obdemo -p***** -A
   ```

2. 查询指定租户的 `TENANT_ROLE`。

   由于一个 SERVICE_NAME 下最多只有一个主租户，故在创建服务前，需要确认租户的角色。

   语句示例如下：

   ```shell
   obclient [oceanbase]> SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = mysql_tenant;
   ```

3. 查询待创建的 SERVICE_NAME 下的租户情况。

   以下语句只能查询当前集群中所有具有指定 SERVICE_NAME 的主备租户的名字及其租户 ID。对于跨集群的物理备库场景，则对应的集群都需要查询。

   语句示例如下：

   ```shell
   obclient [oceanbase]> SELECT t.tenant_id, t.tenant_name, t.tenant_role
   FROM oceanbase.CDB_OB_SERVICES AS s JOIN oceanbase.DBA_OB_TENANTS AS t
   ON s.tenant_id = t.tenant_id 
   WHERE s.service_name = 's_hz';
   ```

   根据查询结果：

   * 如果查询结果全部为空，则表示该 SERVICE_NAME 为全新的 SERVICE_NAME，可以使用该 SERVICE_NAME 为主租户创建服务。
  
   * 如果查询结果不为空，并且查询结果中无其他主租户，同时该租户与查询结果中的备租户具有主备关系，则可以使用 SERVICE_NAME 创建服务。

## 步骤二：创建服务

给租户创建服务时，对于具有主备关系的租户，需要分别为主租户和备租户创建同名的服务。

1. 租户管理员登录集群的用户租户或 sys 租户。

2. 为租户创建服务。

   语句如下：

   ```sql
   ALTER SYSTEM CREATE SERVICE service_name [TENANT [=] tenant_name];
   ```

   语句中：

   * `service_name`：指定待创建的服务名。服务名对大小写不敏感，字母开头，长度为 1 ~ 64 字节的字符串，可以包含字母，数字和下划线。
   * `TENANT [=] tenant_name`：指定待创建服务的租户名。仅 `sys` 租户可以指定租户，用户租户不能指定租户。

   示例如下：

   * 系统租户为租户 `mysql_tenant` 创建名为 `s_hz` 的服务。

      ```shell
      obclient [oceanbase]> ALTER SYSTEM CREATE SERVICE s_hz TENANT = mysql_tenant;
      ```

   * 用户租户为本租户创建名为 `s_hz` 的服务。

      ```shell
      obclient > ALTER SYSTEM CREATE SERVICE s_hz;
      ```

## 相关文档

* [查看服务状态](200.view-service-status.md)
* [启动服务](300.start-service.md)
* [暂停服务](400.stop-service.md)
* [删除服务](500.delete-service.md)