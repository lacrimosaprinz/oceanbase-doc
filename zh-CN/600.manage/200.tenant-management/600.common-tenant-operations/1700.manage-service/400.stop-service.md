|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 暂停服务

服务运行过程中，可以通过 `STOP SERVICE` 命令暂停服务。暂停服务后，用户将不同再通过该 SERVICE_NAME 来连接数据库。

## 使用限制

不允许在通过 SERVICE_NAME 建立的 Session 中执行 `STOP SERVICE` 命令。

## 前提条件

* 执行 `STOP SERVICE` 命令要求用户具有 `ALTER SYSTEM` 权限。

* 暂停服务时，要求租户的 Unit 中没有临时下线的机器。

  1. 使用 `root` 用户登录当前租户所在集群的 `sys` 租户。

  2. 查询租户的 Unit 中是否有下线的机器，并获取下线机器的 `LAST_OFFLINE_TIME`。

     ```shell
     obclient [oceanbase]> SELECT SVR_IP, SVR_PORT, LAST_OFFLINE_TIME, NOW() FROM oceanbase.DBA_OB_SERVERS WHERE LAST_OFFLINE_TIME IS NOT NULL AND (SVR_IP, SVR_PORT) IN (SELECT DISTINCT SVR_IP, SVR_PORT FROM oceanbase.DBA_OB_UNITS WHERE TENANT_ID = user_tenant_id);
     ```

     其中，`user_tenant_id` 需要替换为目标租户的 `TENANT_ID`。

     如果查询结果为空，则表示无临时下线的机器。如果查询结果不为空，则需要判断该机器是否为永久下线的机器。

  3. 如果确认租户的 Unit 中有下线的机器，则需要查询配置项 `server_permanent_offline_time` 的值。然后根据上一步获取的 `LAST_OFFLINE_TIME` 与配置项的值，判断机器的永久下线时间。

    集群级配置项 `server_permanent_offline_time` 用于设置节点心跳中断的时间阈值，即节点心跳中断多久后认为其被永久下线，永久下线的节点上的数据副本需要被自动补足。有关该配置项的更多详细信息，参见 [server_permanent_offline_time](../../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/300.cluster-level-configuration-items/19000.server_permanent_offline_time.md)。

    ```sql
    obclient [oceanbase]> SHOW PARAMETERS LIKE 'server_permanent_offline_time';
    ```

    根据查询结果，如果 `LAST_OFFLINE_TIME + server_permanent_offline_time` 大于 `NOW()`，则表示机器已经永久下线了，否则机器就是临时下线。

    根据确认结果，如果租户有 Unit 在临时下线或永久下线的机器上，则需要保证该机器临时下线或永久下线是因为宕机导致，否则无法暂停服务。

## 操作步骤

1. 租户管理员登录集群的用户租户或 sys 租户。

2. 查看待暂停的服务的状态是否为 `STOPPED`。

   查询租户的服务状态的详细操作，参见 [查看服务状态](200.view-service-status.md)。

   如果租户的服务状态不为 `STOPPED`，则要求当前租户的 `SWITCHOVER_STATUS` 为 `NORMAL`，即当前租户不处于主备切换的中间状态。查询租户的 `SWITCHOVER_STATUS` 的方法如下：

   * 系统租户下查询指定租户的 `SWITCHOVER_STATUS`

      ```shell
      obclient [oceanbase]> SELECT TENANT_ID, TENANT_NAME, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = mysql_tenant;
      ```

   * 用户租户查询本租户的 `SWITCHOVER_STATUS`

      :::tab
      tab MySQL 模式

      MySQL 模式下的查询语句如下：

      ```shell
      obclient [oceanbase]> SELECT TENANT_ID, TENANT_NAME, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS;
      ```

      tab Oracle 模式

      Oracle 模式下的查询语句如下：

      ```shell
      obclient [SYS]> SELECT TENANT_ID, TENANT_NAME, SWITCHOVER_STATUS FROM SYS.DBA_OB_TENANTS;
      ```

      :::

3. 暂停服务。

   语句如下：

   ```sql
   ALTER SYSTEM STOP SERVICE service_name [TENANT [=] tenant_name];
   ```

   语句中：

   * `service_name`：指定待暂停的服务名。
   * `TENANT [=] tenant_name`：指定待暂停服务的租户名。仅 `sys` 租户可以指定租户，用户租户不能指定租户。

   示例如下：

   * 系统租户为租户 `mysql_tenant` 暂停名为 `s_hz` 的服务。

      ```shell
      obclient [oceanbase]> ALTER SYSTEM STOP SERVICE s_hz TENANT = mysql_tenant;
      ```

   * 用户租户暂停名为 `s_hz` 的服务。

      ```shell
      obclient > ALTER SYSTEM STOP SERVICE s_hz;
      ```

   暂停服务后，原来已通过 SERVICE_NAME 建立的 Session 将会断开连接，并且不能再通过 SERVICE_NAME 建立的新的 Session。

## 相关文档

* [查看服务状态](200.view-service-status.md)
* [启动服务](300.start-service.md)
* [删除服务](500.delete-service.md)