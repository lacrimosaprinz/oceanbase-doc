|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# 为用户指定生效或失效的角色

您可以根据需要指定用户生效或失效的角色。

一个用户可以被授予多个角色。授予角色后，您可以再针对这些角色，设置哪些生效。设置后，用户将拥有生效角色的所有权限，用户不拥有失效角色中所包含的权限。

## 指定用户在登录时默认生效或失效的角色

OceanBase 数据库的 MySQL 模式支持通过 `SET DEFAULT ROLE` 语句或 `ALTER USER` 语句的 `DEFAULT ROLE` 子句指定用户在登录时默认生效或失效的角色。

### 前提条件

<main id="notice" type='notice'>
<h4>注意</h4>
<p>如果用户是为自身设置在登录时默认生效或失效已经被授予的角色，则不需要任何权限。</p>
</main>

* 当前用户必须拥有待指定的角色，并且拥有 `GRANT OPTION` 权限，才能执行本操作。

* 当前用户还必须拥有 `CREATE USER` 管理权限，才可以执行 `SET DEFAULT ROLE` 语句或 `ALTER USER` 语句。

### 注意事项

仅支持指定通过 `GRANT` 语句直接授予用户的角色或由具有 `CREATE ROLE` 权限的用户创建的角色，不能指定以下角色：

* 未授予用户的角色

  不能指定生效或失效用户未被授予的角色。

* 通过其他角色授予的角色

  不能指定生效或失效通过其他角色授予的角色。

### 通过 `SET DEFAULT ROLE` 语句设置的操作示例

使用 `SET DEFAULT ROLE` 语句时，每条语句支持同时指定多个用户在登录时默认生效或失效的角色。

* 指定用户 `test1` 在登录时，默认失效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> SET DEFAULT ROLE NONE TO test1;
  ```

  如果需要指定多个用户，例如，指定用户 `test1` 和 `test2` 在登录时默认失效用户被授予的所有角色，示例如下：

  ```shell
  obclient [oceanbase]> SET DEFAULT ROLE NONE TO test1,test2;
  ```

* 指定用户 `test1` 在登录时，默认生效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> SET DEFAULT ROLE ALL TO test1;
  ```

* 指定用户 `test1` 在登录时，默认生效用户被授予的 `employee` 和 `developer` 角色

  ```shell
  obclient [oceanbase]> SET DEFAULT ROLE employee,developer TO test1;
  ```

### 通过 `ALTER USER` 语句设置的操作示例

使用 `ALTER USER` 语句时，每条语句仅支持指定一个用户在登录时生效或失效的角色。

* 指定用户 `test1` 在登录时，默认失效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> ALTER USER test1 DEFAULT ROLE NONE;
  ```

* 指定用户 `test1` 在登录时，默认生效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> ALTER USER test1 DEFAULT ROLE ALL;
  ```

* 指定用户 `test1` 在登录时，默认生效用户被授予的 `employee` 和 `developer` 角色

  ```shell
  obclient [oceanbase]> ALTER USER test1 DEFAULT ROLE employee,developer;
  ```

除了上述语句，拥有 `ALTER SYSTEM` 权限的用户还可以通过 Global 动态变量 `activate_all_roles_on_login` 设置登录时默认自动生效用户被授予的所有角色。该变量的默认值为 `off`，表示登录时默认不自动生效用户被授予的所有角色。

设置登录时默认自动生效用户被授予的所有角色的语句如下：

```shell
obclient [oceanbase]> SET GLOBAL activate_all_roles_on_login = on;
```

由于该变量为动态变量，设置后也会影响当前会话。

## 指定当前会话中生效的角色

OceanBase 数据库的 MySQL 模式支持在当前会话中通过 `SET ROLE` 语句指定生效或失效当前登录用户被授予的角色。

<main id="notice" type='explain'>
<h4>说明</h4>
<p>通过 <code>SET ROLE</code> 语句生效或失效的角色，仅影响当前 Session，不影响之后的 Session。</p>
</main>

操作示例如下：

* 指定在当前会话中。

  ```shell
  obclient [oceanbase]> SET ROLE DEFAUL;
  ```

* 指定在当前会话中失效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> SET ROLE NONE;
  ```

* 指定在当前会话中生效用户被授予的所有角色

  ```shell
  obclient [oceanbase]> SET ROLE ALL;
  ```

* 指定在当前会话中，生效用户被授予的所有角色中除了指定角色以外的的其他所有角色

  ```shell
  obclient [oceanbase]> SET ROLE ALL EXCEPT role1;
  ```

* 指定在当前会话中，生效用户被授予的指定的角色

  ```shell
  obclient [oceanbase]> SET ROLE employee,developer;
  ```
