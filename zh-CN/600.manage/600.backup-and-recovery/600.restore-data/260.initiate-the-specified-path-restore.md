# 执行指定路径的恢复

当数据备份集和日志归档 Piece 由于业务原因手动搬迁至其他路径后，您可以通过加载对应的数据备份集和日志归档 Piece 后再发起恢复命令的方式来恢复租户。

## 前提条件

* 请确认已获取待恢复的数据备份集和日志归档 Piece 的存放路径。如果是存放在对象存储上，则要求数据备份集和日志归档 Piece 存放路径中的 `host`、`access_id `以及 `access_key` 等参数信息均相同。

* 请确认待恢复的数据备份集和日志归档 Piece 属于同一租户，当前仅允许从同一个租户的备份集和日志归档 Piece 中恢复出新租户。

* 请确认已完成恢复前准备，具体操作请参见 [恢复前准备](../600.restore-data/100.preparation-before-recovery.md)。

## 操作步骤

1. 使用 `root` 用户登录待恢复的租户所在集群的 `sys` 租户。

2. 执行 `ALTER SYSTEM RESTORE...PREVIEW` 命令，进行预恢复。

   语句如下：

   ```sql
   ALTER SYSTEM RESTORE dest_tenant_name FROM source_tenant_name AT 'uri' UNTIL 'timestamp' WITH 'restore_option' PREVIEW;
   ```

   相关参数说明如下：

   * `dest_tenant_name`：指定待恢复的新租户名。

   * `source_tenant_name`：指定源租户名。

   * `uri`：指定数据备份集的存放路径和日志归档 Piece 的存放路径，用逗号分隔。
      
   * `timestamp`：指定待恢复的时间戳。该时间需要大于等于最早备份的 `CDB_OB_BACKUP_SET_DETAILS/DBA_OB_BACKUP_SET_DETAILS` 视图中的 `START_REPLAY_SCN_DISPLAY`，小于等于 `CDB_OB_BACKUP_SET_DETAILS/DBA_OB_BACKUP_SET_DETAILS` 视图中 `MIN_RESTORE_SCN_DISPLAY`。

   * `restore_option`：与物理恢复一致，支持指定 `pool_list`、`locality`、`primary_zone`、`concurrency`，不同参数之间通过 `&` 分隔。在指定 `locality` 和 `primary_zone` 时，建议尽量与源租户保持同构。如果不同构，待租户恢复后激活为主租户可能会产生负载均衡操作，影响性能。

      * `pool_list`：必选，填写为待恢复的新租户创建的资源池。多个资源池之间用英文逗号（,）分隔。
      
      * `Locality`：指定新租户副本分布的 Locality 信息，需要与新租户所在集群的 `pool_list` 的 Zone 信息相匹配。与源租户保持同构时，建议新租户与源租户的 F 副本个数相同。

      * `primary_zone`：指定新租户的 Leader 副本的偏好位置，需要与 `pool_list` 及 `locality` 相匹配。与源租户保持同构时，建议新租户与源租户的第一优先级的 Primary Zone 个数相同。

      * `concurrency`：指定数据恢复的并发度。如果不指定，则默认等于该租户被分配的 `MAX_CPU` 数。例如，本文档中，系统租户为待恢复的租户分配的 `MAX_CPU` 为 16。

      有关各参数的详细说明请参见 [物理恢复相关参数介绍](800.parameters-of-the-restore.md)。

   示例如下：

   ```shell
   obclient> ALTER SYSTEM RESTORE mysql FROM info AT 'file:///data/nfs/backup/data,file:///data/nfs/backup/archive' UNTIL '2024-04-03 00:00:00' WITH 'pool_list=restore_pool&locality=F@z1,F@z2,F@z3&primary_zone=z1' PREVIEW;
   ```

3. 执行 `SHOW RESTORE PREVIEW` 命令，获取可恢复的数据备份集和日志归档 Piece 列表。

   ```shell
   obclient> SHOW RESTORE PREVIEW;
   ```

4. 执行 `ADD RESTORE SOURCE` 命令，分别加载待恢复的数据备份集路径和日志归档 Piece 路径。

   加载恢复路径的语句如下：

   ```sql
   ALTER SYSTEM ADD RESTORE SOURCE 'restore_path';
   ```

   语句使用说明：

   * `restore_path` 用于填写待加载的备份集或日志归档 Piece 的路径列表，即可以是一个路径，也可以是多个路径。填写路径时，数据备份集路径或归档日志 Piece 路径可以与源备份路径不一致。

  * 加载数据备份集时，至少需要加载一个全量备份集。

   * 该语句可以连续多次执行，但多次执行中间不允许执行除该语句外的其他 SQL 语句，否则会报错。

   * 使用该语句进行恢复时，`ALTER SYSTEM ADD RESTORE SOURCE` 语句与 `ALTER SYSTEM RESTORE` 恢复语句中间不允许执行其他 SQL 语句。

   示例如下：

   1. 加载待恢复的数据备份集。

      ```sql
      obclient> ALTER SYSTEM ADD RESTORE SOURCE 'file:///data/nfs/backup/data/backup_set_1_full';
      ```

   2. 加载待恢复的日志归档 Piece。

      ```sql
      obclient> ALTER SYSTEM ADD RESTORE SOURCE 'file:///data/nfs/backup/archive/piece_d1002r1p1';
      ```

    语句执行成功后，如果发现加载的路径输入错误，可以执行以下语句来撤销之前的输入后，再重新加载正确的恢复路径。

    ```sql
    obclient> ALTER SYSTEM CLEAR RESTORE SOURCE;
    ```

5. 路径加载成功后，执行以下语句，调用恢复命令。

   ```sql
   ALTER SYSTEM RESTORE dest_tenant_name UNTIL 'restore_checkpoint' WITH 'restore_option';
   ```

   部分参数说明如下：

   * `dest_tenant_name`：待恢复的新租户的名称。

   * `restore_checkpoint`：指定希望恢复到的时间戳。

   * `restore_option`：支持指定 `pool_list`、`locality`、`primary_zone`、`concurrency`，不同参数之间通过 `&` 分隔。在指定 `locality` 和 `primary_zone` 时，建议尽量与源租户保持同构。如果不同构，待租户恢复后激活为主租户可能会产生负载均衡操作，影响性能。

      * `pool_list`：必选，填写为待恢复的新租户创建的资源池。多个资源池之间用英文逗号（,）分隔。
      
      * `Locality`：指定新租户副本分布的 Locality 信息，需要与新租户所在集群的 `pool_list` 的 Zone 信息相匹配。与源租户保持同构时，建议新租户与源租户的 F 副本个数相同。

      * `primary_zone`：指定新租户的 Leader 副本的偏好位置，需要与 `pool_list` 及 `locality` 相匹配。与源租户保持同构时，建议新租户与源租户的第一优先级的 Primary Zone 个数相同。

      * `concurrency`：指定数据恢复的并发度。如果不指定，则默认等于该租户被分配的 MAX_CPU 数。例如，本文档中，系统租户为待恢复的租户分配的 MAX_CPU 为 16。

      有关各参数的详细说明请参见 [物理恢复相关参数介绍](800.parameters-of-the-restore.md)。

   恢复示例如下：

   ```sql
   obclient> ALTER SYSTEM RESTORE mysql UNTIL '2024-04-03 00:00:00' WITH 'pool_list=restore_pool&locality=F@z1,F@z2,F@z3&primary_zone=z1';
   ```

## 后续操作

* 发起恢复任务后，您可以通过视图查看恢复的进度和结果，具体操作请参见 [查看恢复进度](../600.restore-data/400.view-the-restore-progress.md)。

* 恢复任务完成后，如果您是从低版本的备份数据恢复到高版本集群中的场景，还需要对恢复出来的租户进行升级，具体操作请参见 [恢复完成后升级租户](610.update-the-tenant-after-the-restore.md)。

* 物理恢复流程与物理备库统一，物理恢复后的租户为备租户，后续该租户可作为备租户提供相关服务，也可转为主租户提供服务。作为备租户继续日志归档从源租户回放日志的详细操作参见 [备租户分段回放日志](510.recover-the-standby-tenant.md)；将备租户转为主租户的详细操作请参见 [备租户转为主租户](600.active-standby-tenant.md)。

## 相关文档

更多恢复相关的介绍，请参见 [恢复架构](../../../700.reference/100.oceanbase-database-concepts/1000.high-data-reliability-and-availability/500.backup-and-recovery/400.recovery-architecture.md)。


