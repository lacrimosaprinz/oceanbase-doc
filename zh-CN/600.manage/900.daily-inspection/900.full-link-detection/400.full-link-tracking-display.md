|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 全链路追踪展示

Show Trace 功能可以为用户提供便捷的业务系统关联能力。用户可以通过 JDBC 接口或 SQL 接口，在业务数据库连接上设置调用请求对应的 Trace ID。该 Trace ID 会记录到 OceanBase 数据库全链路追踪系统中，从而方便用户进行系统性能分析和故障排查。在使用 Show Trace 命令时，用户可以查看 Trace ID 对应的信息，以便更好地理解系统运行情况。

## 通过 OCP 工具查看

用户可以通过 OceanBase 运维平台（OCP）快速检索到有问题的请求，以便进行系统性能分析和故障排查。

### 定位分析

OCP 提供了多种检索维度，例如按耗时检索、按指定 Trace ID 或 SQL ID 检索等，方便用户快速定位出问题的阶段。此外，OCP 还提供了直观的全链路追踪信息展示功能，用户可以查看请求从客户端到数据库内部全链路各组件的执行信息，从而更好地理解系统运行情况。

### 操作步骤

在 OCP 中可通过以下步骤查询链路信息，更多内容请参见 [查询链路](https://www.oceanbase.com/docs/enterprise-oceanbase-ocp-cn-10000000002100810)。

1. 登录 OCP。
2. 在左侧导航栏中选择 **系统管理 > 日志服务**。
3. 单击 **链路查询** 页签，进入 **链路查询** 界面。
4. 可通过在 **链路查询** 界面中设置查询条件，辅助定位目标 Trace。
5. 单击 **查询** 按钮。将光标悬停至 span 节点的时间轴上，在弹窗中将展示 span 的详细信息。

![OCP 界面展示](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E9%93%BE%E8%B7%AF%E8%AF%A6%E6%83%851.png)

## 通过命令行查看

用户可以在 OceanBase 数据库的交互场景使用 Show Trace 能力，通过 Show Trace 命令快速定位问题。

### 定位分析

当用户在命令行中手动执行某个语句后，如果需要对其执行过程进行性能分析或调优，可以使用  Show Trace 功能来查看该语句的执行调用链路情况以及链路中各阶段的耗时情况。通过该功能，用户可以便捷地找到性能瓶颈点，进而进行分析和优化。

### 操作步骤

如下示例展示了两个分布式并行执行任务（px_task）的执行情况。若要查看链路有关的日志信息，请参见 [基于 Trace 功能查找上一次 SQL 请求日志](https://www.oceanbase.com/docs/common-oceanbase-database-cn-10000000001702462)。

1. 打开 SQL Trace 功能。

    ```sql
    obclient [test]>SET ob_enable_show_trace = 1;
    ```

2. 手动执行需要查询的 SQL 语句。

    ```sql
    obclient [test]>select/*+parallel(2)*/ count(*) from t1;
    +----------+
    | count(*) |
    +----------+
    |        5 |
    +----------+
    1 row in set (0.005 sec)
    ```

3. 通过 SHOW TRACE 语句查看该语句的执行调用链路情况以及链路中各阶段的耗时情况。

    ```sql
    obclient [test]>show trace;
    +-------------------------------------------+----------------------------+------------+
    | Operation                                 | StartTime                  | ElapseTime |
    +-------------------------------------------+----------------------------+------------+
    | obclient                                  | 2023-06-25 17:51:30.143537 | 4.667 ms   |
    | └─ ob_proxy                               | 2023-06-25 17:51:30.143716 | 4.301 ms   |
    |    └─ com_query_process                   | 2023-06-25 17:51:30.145119 | 2.527 ms   |
    |       └─ mpquery_single_stmt              | 2023-06-25 17:51:30.145123 | 2.513 ms   |
    |          ├─ sql_compile                   | 2023-06-25 17:51:30.145133 | 0.107 ms   |
    |          │  └─ pc_get_plan                | 2023-06-25 17:51:30.145135 | 0.061 ms   |
    |          └─ sql_execute                   | 2023-06-25 17:51:30.145252 | 2.350 ms   |
    |             ├─ open                       | 2023-06-25 17:51:30.145252 | 0.073 ms   |
    |             ├─ response_result            | 2023-06-25 17:51:30.145339 | 2.186 ms   |
    |             │  ├─ px_schedule             | 2023-06-25 17:51:30.145342 | 1.245 ms   |
    |             │  │  ├─ px_task              | 2023-06-25 17:51:30.146391 | 1.113 ms   |
    |             │  │  │  ├─ get_das_id        | 2023-06-25 17:51:30.146979 | 0.001 ms   |
    |             │  │  │  ├─ do_local_das_task | 2023-06-25 17:51:30.147012 | 0.050 ms   |
    |             │  │  │  └─ close_das_task    | 2023-06-25 17:51:30.147237 | 0.014 ms   |
    |             │  │  └─ px_task              | 2023-06-25 17:51:30.146399 | 0.868 ms   |
    |             │  │     ├─ get_das_id        | 2023-06-25 17:51:30.147002 | 0.001 ms   |
    |             │  │     ├─ do_local_das_task | 2023-06-25 17:51:30.147036 | 0.041 ms   |
    |             │  │     └─ close_das_task    | 2023-06-25 17:51:30.147183 | 0.011 ms   |
    |             │  └─ px_schedule             | 2023-06-25 17:51:30.147437 | 0.001 ms   |
    |             └─ close                      | 2023-06-25 17:51:30.147536 | 0.049 ms   |
    |                └─ end_transaction         | 2023-06-25 17:51:30.147571 | 0.002 ms   |
    +-------------------------------------------+----------------------------+------------+
    ```
