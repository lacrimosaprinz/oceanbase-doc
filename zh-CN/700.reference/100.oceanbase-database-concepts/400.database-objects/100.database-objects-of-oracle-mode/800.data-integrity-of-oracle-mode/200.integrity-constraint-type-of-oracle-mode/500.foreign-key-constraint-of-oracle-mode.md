|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# 外键约束 

每当两个表包含一个或多个公共列时，OceanBase 数据库 Oracle 模式下可以通过外键约束（也称为参照完整性约束）强制执行两个表之间的关系。

## 外键约束的特性 

外键约束要求，对于定义约束的列中的每个值，与另一个指定的表和列中的值必须匹配。语法格式如下：

```sql
REFERENCES [ schema. ] object [ (column_name [, column_name...]) ] [ON DELETE { CASCADE | SET NULL } ]
```

参照完整性约束相关的术语如下表所示。

|             术语              |  定义     |
|-----------------------------|----------------------------------|
| 外键（Foreign key）             | 引用 Referenced Key 的约束定义中包含的列或列集。 外键可以定义为多列。但是，复合外键必须引用具有相同列数和相同数据类型的复合主键或唯一键。 外键的值可以匹配引用的主键值或唯一键值，也可以为空。如果复合外键的任何列为空，则键的非空部分不必与父键的任何相应部分匹配。 |
| 引用键（Referenced Key）         | 外键引用的表的唯一键或主键。      |
| 子表（Dependent/Child Table）   | 包含外键的表。此表取决于引用的唯一键或主键中存在的值。   |
| 父表（Referenced/Parent table） | 子表的外键所引用的表。正是这个表的引用键决定了在子表中是否允许指定的插入或更新。       |


**示例** ：创建包含外键约束的表。

```sql
obclient> CREATE TABLE supplier_groups(
     group_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
     group_name VARCHAR2(127) NOT NULL,
​     PRIMARY KEY (group_id)  
      );
Query OK, 0 rows affected

obclient> CREATE TABLE suppliers (
     supplier_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
     supplier_name VARCHAR2(127) NOT NULL,
     group_id NUMBER NOT NULL,
     PRIMARY KEY(supplier_id),
     CONSTRAINT fk_name FOREIGN KEY(group_id) REFERENCES supplier_groups(group_id)
     );
Query OK, 0 rows affected
```

外键约束的主要特性如下：

* 自引用完整性约束

  自引用完整性约束是引用同一表中父键的外键。​建表示例如下：

  ```sql
  obclient> CREATE TABLE employee (
  employee_id INT PRIMARY KEY, 
  employee_name VARCHAR(30), 
  salary VARCHAR(30), 
  manager_id INT, 
  CONSTRAINT sr_fk_emp_man FOREIGN KEY (manager_id) REFERENCES employee(employee_id)
  );
  ```

* 空值和外键

  关系模型允许外键的值匹配引用的主键或唯一键值，或者为空。如果复合外键的任何列为空，则键的非空部分不必与父键的任何相应部分匹配。
  
* 父键修改和外键

  外键和父键之间的关系对删除父键有影响。​修改父键时，参照完整性约束，可以指定要对子表中的受影响的行执行 `DELETE NO ACTION` 或者 `DELETE CASCADE` 操作。

  下表概述了对父表中的键值和子表中的外键值的不同引用操作所允许的 DML 语句。
  

  |      DML 语句      |            针对父表的操作            |            针对子表的操作            |
  |------------------|-------------------------------|-------------------------------|
  | INSERT           | 父表键唯一则允许写入                    | 当外键值存在于父键中，或者部分（或全部）为空时才允许写入。 |
  | DELETE NO ACTION | 如果子表中没有匹配的记录，则允许对父表对应键进行删除操作。 | 无限制条件                         |
  | DELETE CASCADE   | 无限制条件                         | 无限制条件                         |

* **索引和外键** 

  通常来说，外键列应该是索引列。唯一的例外是匹配的唯一键或主键从未更新或删除。索引子表中的外键有以下好处：
  * 防止子表上的全表锁定。数据库只需要获取索引上的行锁。

  * 无需对子表进行全表扫描。​

  <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>OceanBase 数据库 Oracle 模式下外键暂不支持如下行为：</p>
    <ul>
    <li>不支持 <code>SET NULL</code> 行为。</li>
    <li>不支持语句级检测。</li>
    <li>不支持延迟约束检查。</li>
    </ul>
  </main>

## 外键约束的常用操作 

* 将外键约束添加到表中。

  ```sql
  ALTER TABLE child ADD CONSTRAINT fk_name_1 
  FOREIGN KEY (col1) REFERENCES parent (col1);
  ```

* 删除外键约束。

  ```sql
  ALTER TABLE child DROP CONSTRAINT fk_name_1; 
  ```

* 禁用外键约束。

  ```sql
  ALTER TABLE child DISABLE CONSTRAINT fk_name_1; 
  ```

* 启用外部约束。

  ```sql
  ALTER TABLE child ENABLE CONSTRAINT fk_name_1;
  ```

  



