|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# 子程序 

子程序是包含很多 SQL 和 PL 语句的 PL 单元，以解决特定的问题或者执行一组相关的任务。

子程序可以包含参数，具体值由调用者传入。子程序可以是一个存储过程或者函数。典型的用法是使用存储过程进行一个操作，使用函数进行计算并返回一个值。

存储子程序是存储在数据库内部的子程序，为很多不同数据库应用程序实现复杂的逻辑运算。存储子程序包含如下三类：

* 独立的子程序，即在 Schema 内创建的子程序。

* 包内部的子程序，即在包体内部创建的子程序。

* 嵌套的子程序，即在 PL 块内创建的子程序。

独立的子程序对测试程序逻辑很方便，但是大量的子程序不是很方便管理。因此建议在程序逻辑确定后，将独立的子程序按照业务模块放到不同的包里。

子程序是其他可维护性功能的重要组成部分，例如程序包和触发器等。

## 子程序结构 

子程序以子程序标题开头，该标题指定其名称和其参数列表（可选）。

子程序结构跟 PL 块结构一致，包括：

* 声明部分（可选）

  声明部分包括类型、常量、变量、异常、显式游标和嵌套子程序的声明。这些项对于子程序都是本地的，当子程序执行结束时就都不存在了。

* 执行部分（必选）

  执行部分包括赋值语句、控制执行语句和数据操作语句。

* 异常处理部分（可选）

  异常处理部分包括处理异常（运行时错误）的代码。
  
在子程序中添加注释会增加程序的可读性，注释可以出现在子程序的任意位置，编译器会忽略注释。单行注释是以双横线（--）开头的，注释范围到行尾截止。多行注释可以以斜杠和星号（/\*）开头，以星号和斜杠（\*/）结尾。

一个存储过程的结构如下：

```sql
PROCEDURE name [ ( parameter_list ) ]
{ IS | AS }
[ declarative_part ]
BEGIN    -- 开始执行部分
statement; [ statement; ]...
[ EXCEPTION ]
exception_handler; [ exception_handler; ]... ]
END;
```

一个函数的结构如下，与存储过程相比，多了一个或多个 `RETURN` 子句：

```sql
FUNCTION name [ ( parameter_list ) ] RETURN data_type [ clauses ]
{ IS | AS }
[ declarative_part ]
BEGIN  
statement; [ statement; ]...
[ EXCEPTION ]
exception_handler; [ exception_handler; ]... ]
END;
```

存储过程和函数跟 `IS | AS` 之间的代码是子程序的声明，声明部分、执行部分和异常处理部分是子程序的内容体。

## 子程序优点 

相比于客户端程序，子程序有如下优点：

* 提高性能

  减少网络传输带来的代价；可以提前编译，甚至使用 Cache 机制缓存，减少执行时期的性能消耗。
  
* 减少内存消耗

  数据库的共享内存机制会在多个用户执行同一个存储过程时减少内存的消耗。

* 提高生产力

  存储过程可以为用户减少代码逻辑，提高用户的生产力。
  
* 提高安全性

  通过指定存储过程的权限信息，提高安全性。
  
* 具有可继承性

  用户可以通过获取权限来访问其他用户定义好的存储过程。
  
## 子程序的执行 

可以通过以下三种方式执行子程序：

* 使用客户端工具（OBClient）

* 在应用程序中直接调用子程序

* 在子程序或者触发器中调用

## 依赖关系管理 

在子程序的包体中引用的对象构成子程序的依赖对象。数据库自动跟踪和管理这些依赖关系。

例如，如果用户修改了被子程序依赖的表定义，那么子程序必须被重新编译以确定子程序是否依然有效。通常这种依赖变更后子程序的重新编译由数据库依赖管理单元自动完成。
