|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||

# 查看租户会话

您可以通过视图或 SQL 语句查看租户会话。

## 通过视图查看租户会话

1. 用户登录集群的 MySQL 租户或 Oracle 租户。

2. 执行以下语句，查看租户会话信息。

   租户管理员可以查看当前租户内的所有会话信息，普通用户只能查看当前自己的会话信息。如果您拥有 `PROCESS` 权限，则可以查看所有会话。

   * MySQL 模式

      ```sql
      SELECT * FROM oceanbase.GV$OB_PROCESSLIST;
      ```

      查询结果如下：

      ```shell
      +----------------+----------+----------+------------+------+----------------------+-----------+----------+---------+-------+------------+--------+-------------------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      | SVR_IP         | SVR_PORT | SQL_PORT | ID         | USER | HOST                 | DB        | TENANT   | COMMAND | TIME  | TOTAL_TIME | STATE  | INFO                                      | PROXY_SESSID | MASTER_SESSID | USER_CLIENT_IP | USER_HOST | RETRY_CNT | RETRY_INFO | SQL_ID                           | TRANS_ID | THREAD_ID | SSL_CIPHER | TRACE_ID                          | TRANS_STATE | ACTION | MODULE | CLIENT_INFO | LEVEL | SAMPLE_PERCENTAGE | RECORD_POLICY         | LB_VID | LB_VIP | LB_VPORT | IN_BYTES | OUT_BYTES |
      +----------------+----------+----------+------------+------+----------------------+-----------+----------+---------+-------+------------+--------+-------------------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      | xx.xx.xx.xx    |     2882 |     2881 | 3221487669 | root | xx.xx.xx.xx:43325    | NULL      | mysql001 | Query   |     0 |          0 | ACTIVE | SELECT * FROM oceanbase.GV$OB_PROCESSLIST |         NULL |          NULL | xx.xx.xx.xx    | %         |         0 |          0 | 2E175335D36600B7A8EC72C5094888DD |        0 |     67793 | NULL       | YB42AC1E87C0-000604A74DB36453-0-0 |             |        |        |             |     1 |                10 | SAMPLE_AND_SLOW_QUERY |   NULL | NULL   |     NULL |      472 |       734 |
      | xx.xx.xx.xx    |     2882 |     2881 | 3221487666 | root | xx.xx.xx.xx:19326    | oceanbase | mysql001 | Sleep   | 18421 |      18421 | SLEEP  | NULL                                      |         NULL |          NULL | xx.xx.xx.xx    | %         |         0 |          0 |                                  |        0 |         0 | NULL       | NULL                              |             |        |        |             |     1 |                10 | SAMPLE_AND_SLOW_QUERY |   NULL | NULL   |     NULL |      573 |     10349 |
      +----------------+----------+----------+------------+------+----------------------+-----------+----------+---------+-------+------------+--------+-------------------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      2 rows in set
      ```

   * Oracle 模式

      ```sql
      SELECT * FROM SYS.GV$OB_PROCESSLIST;
      ```

      查询结果如下：

      ```shell
      +----------------+----------+----------+------------+------+----------------------+------+-----------+---------+-------+------------+--------+---------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      | SVR_IP         | SVR_PORT | SQL_PORT | ID         | USER | HOST                 | DB   | TENANT    | COMMAND | TIME  | TOTAL_TIME | STATE  | INFO                            | PROXY_SESSID | MASTER_SESSID | USER_CLIENT_IP | USER_HOST | RETRY_CNT | RETRY_INFO | SQL_ID                           | TRANS_ID | THREAD_ID | SSL_CIPHER | TRACE_ID                          | TRANS_STATE | ACTION | MODULE | CLIENT_INFO | LEVEL | SAMPLE_PERCENTAGE | RECORD_POLICY         | LB_VID | LB_VIP | LB_VPORT | IN_BYTES | OUT_BYTES |
      +----------------+----------+----------+------------+------+----------------------+------+-----------+---------+-------+------------+--------+---------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      | xx.xx.xx.xx    |     2882 |     2881 | 3221487673 | SYS  | xx.xx.xx.xx:30390    | SYS  | oracle001 | Query   |     0 |          0 | ACTIVE | SELECT * FROM GV$OB_PROCESSLIST |         NULL |          NULL | xx.xx.xx.xx    | %         |         0 |          0 | D90D2671435AFEEDC9C0E4A1F9BB7895 |        0 |     68178 | NULL       | YB42AC1E87C0-000604A74D5364E0-0-0 | NULL        | NULL   | NULL   | NULL        |     1 |                10 | SAMPLE_AND_SLOW_QUERY |   NULL | NULL   |     NULL |      570 |       867 |
      | xx.xx.xx.xx    |     2882 |     2881 | 3221487667 | SYS  | xx.xx.xx.xx:19819    | SYS  | oracle001 | Sleep   | 17758 |      17758 | SLEEP  | NULL                            |         NULL |          NULL | xx.xx.xx.xx    | %         |         0 |          0 | NULL                             |        0 |         0 | NULL       | NULL                              | NULL        | NULL   | NULL   | NULL        |     1 |                10 | SAMPLE_AND_SLOW_QUERY |   NULL | NULL   |     NULL |      752 |     13098 |
      +----------------+----------+----------+------------+------+----------------------+------+-----------+---------+-------+------------+--------+---------------------------------+--------------+---------------+----------------+-----------+-----------+------------+----------------------------------+----------+-----------+------------+-----------------------------------+-------------+--------+--------+-------------+-------+-------------------+-----------------------+--------+--------+----------+----------+-----------+
      2 rows in set
      ```

   查询结果中的相关字段说明如下：

   * `SVR_IP`：表示该会话所属的服务器的 IP 地址，即 OBServer 节点的 IP 地址。

   * `SVR_PORT`：表示该会话所属的服务器的 RPC 端口号，即 OBServer 节点的 RPC 端口号。

   * `SQL_PORT`：表示该会话所属的服务器的 SQL 端口号，即 OBServer 节点的 SQL 端口号。

   * `ID`：表示该会话 ID。

   * `USER`：表示该会话所属的用户。

   * `HOST`：通过直连方式连接数据库时，表示发起该会话的客户端 IP 及端口号。如果是通过 ODP 连接数据库，则表示 ODP 的主机 IP 及端口号。

   * `DB`：表示该会话当前连接的数据库名。Oracle 模式显示为与用户名同名的 Schema 名。

   * `TENANT`:表示该会话所访问的租户名称。

   * `COMMAND`：表示该会话正在执行的命令类型。

   * `TIME`：表示当前命令执行的时间，单位为秒。如果命令发生了重试，则系统会清零后重新计算。

   * `TOTAL_TIME`：表示当前命令执行的总时间，单位是秒。如果命令发生了重试，系统不会清零。

   * `STATE`：表示该会话当前的状态。

   * `INFO`：表示该会话正在执行的语句。

   * `PROXY_SESSID`：如果是通过 ODP 连接数据库，则本列显示的是 ODP 节点上的 Session ID。否则显示为 `NULL`。

   * `MASTER_SESSID`：如果是通过 ODP 连接数据库，则本列显示的是 ODP 节点上的主 Session ID，用于串联同一个 SQL 的多个子 Session。否则显示为 `NULL`。

   * `USER_CLIENT_IP`：发起该会话的客户端 IP。

   * `USER_HOST`：发起该会话的客户端主机名。

   * `RETRY_CNT`：当前命令的重试次数。

   * `RETRY_INFO`：当前命令的重试信息，一般为最后一次重试的错误码。

   * `SQL_ID`：当前命令对应的 SQL ID 信息。

   * `TRANS_ID`：事务 ID。

   * `THREAD_ID`：线程 ID。如果是通过 ODP 连接数据库，则该线程 ID 也表示 ODP 节点上的 Session ID。

   * `SSL_CIPHER`：加密密码名称。

   * `TRACE_ID`：Trace ID。

   * `TRANS_STATE`：事务状态。

   * `ACTION`：通过调用 `DBMS_APPLICATION_INFO.SET_ACTION` Procedure 设置的当前执行操作的名称。

   * `MODULE`：通过调用 `DBMS_APPLICATION_INFO.SET_MODULE` Procedure 设置的当前执行操作的名称。

   * `CLIENT_INFO`：通过 `DBMS_APPLICATION_INFO.SET_CLIENT_INFO` 过程设置的信息。

   * `LEVEL`：表示该会话的全链路追踪的监控级别。例如, `1` 表示 Level 为 `1` 的诊断信息。

   * `SAMPLE_PERCENTAGE`：表示该会话的全链路追踪的采样频率。例如, `10` 表示以 10% 的概率进行诊断信息的采样。

   * `RECORD_POLICY`：表示该会话的全链路追踪的记录策略，主要支持以下三种策略:
  
     * `ALL`：表示所有命中采样打开 Trace 的 Trace 打点信息均会打印到日志文件中，并且是在每个 Span 结束时, 即打印到日志文件中。

     * `ONLY_SLOW_QUERY`：表示所有命中采样打开 Trace 的 Trace 打点信息中，属于慢查询的请求 Trace 会打印到日志文件中，其余的均会丢弃。

       对于该打印策略, Trace 日志的打印时机是在请求结束被判定为慢查询后才打印。在 Proxy 中, 对于根 Span 即事务级别的 Span, 是在发现有慢查询时, 就会打印根 Span。

     * `SAMPLE_AND_SLOW_QUERY`：表示所有命中采样打开 Trace 的 Trace 打点信息中，满足以下条件之一的 Trace 均会打印到日志文件:

       1. 当使用隐藏配置项 `_print_sample_ppm` 进行万分之一的概率采样，且只有当采样结果被选中时，才会将其打印到日志中
       2. 满足 `ONLY_SLOW_QUERY` 策略下的打印条件

       此外，该模式下, 日志打印的时机也不是在 Span 结束时，如果满足条件 1，则在客户端就被标记为该 trace 日志会被强制打印，并且该信息会传递到后面的链路组件；如果满足条件 2，则打印时机与 `ONLY_SLOW_QUERY` 策略相同。

       有关全链路追踪的详细介绍，请参见 [全链路追踪](../../600.manage/900.daily-inspection/900.full-link-detection/100.full-link-diagnosis-overview.md)。

   * `LB_VID`：如果是公有云环境上通过负载均衡直接连接数据库，则本列显示的是负载均衡服务的 VPC ID。其他场景下始终显示为 `NULL`。

   * `LB_VIP`：如果是公有云环境上通过负载均衡直接连接数据库，则本列显示的是客户端连接负载均衡服务的 IP。其他场景下始终显示为 `NULL`。

   * `LB_VPORT`：如果是公有云环境上通过负载均衡直接连接数据库，则本列显示的是客户端连接负载均衡服务的端口。其他场景下始终显示为 `NULL`。

   * `IN_BYTES`：该会话的流入流量。

   * `OUT_BYTES`：该会话的流出流量。

## 通过 SHOW PROCESSLIST 语句或 SHOW FULL PROCESSLIST 语句查看租户会话

`SHOW PROCESSLIST` 语句的显示结果与连接数据库的方式有关。当通过 ODP 连接数据库时，显示的是对应的 ODP 节点上的会话信息；当通过直连方式连接数据库时，显示的是租户对应的 OBServer 节点上的会话信息。

查看租户会话时，租户管理员可以查看当前租户内的所有会话信息，普通用户只能查看当前自己的会话信息。如果您拥有 `PROCESS` 权限，则可以查看租户内的所有会话。

<main id="notice" type='explain'>
<h4>说明</h4>
<ul>
<li>
<p>Oracle 模式下，查看权限的相关操作请参见 <a href="../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/300.permission-of-oracle-mode/600.view-user-permissions-of-oracle-mode.md">查看用户权限</a>。如果您没有所需的权限，请联系管理员为您添加，为用户添加权限的相关操作请参见 <a href="../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/300.permission-of-oracle-mode/700.modify-user-permissions-of-oracle-mode.md">修改用户权限</a>。</p>
</li>
<li>
<p>MySQL 模式下，查看当前拥有权限的操作请参见 <a href="../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/400.view-user-permissions-of-mysql-mode.md">查看用户权限</a>。如果您没有所需的权限，请联系管理员为您添加，为用户添加权限的相关操作请参见 <a href="../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/500.modify-user-permissions-of-mysql-mode.md">修改用户权限</a>。</p>
</li>
</ul>
</main>

1. 用户登录集群的 MySQL 租户或 Oracle 租户。

2. 执行以下命令，查看租户会话。

   * 通过直连方式连接数据库时，使用 `SHOW PROCESSLIST` 语句查看租户会话

      ```sql
      SHOW PROCESSLIST;
      ```

      查询结果如下：

      ```shell
      +------------+------+----------------------+-----------+---------+------+--------+------------------+
      | Id         | User | Host                 | db        | Command | Time | State  | Info             |
      +------------+------+----------------------+-----------+---------+------+--------+------------------+
      | 3221487631 | root | xx.xx.xx.xx:44615    | oceanbase | Query   |    0 | ACTIVE | SHOW PROCESSLIST |
      +------------+------+----------------------+-----------+---------+------+--------+------------------+
      1 row in set
      ```

      相关字段说明如下：

      * `Id`：表示该会话的 ID。

      * `User`：表示该会话所属的用户。

      * `Host`：表示发起该会话的客户端 IP 及端口号。

      * `db`：表示该会话当前连接的数据库名。Oracle 模式显示为与用户名同名的 Schema 名。

      * `Command`：表示该会话正在执行的命令类型。

      * `Time`：表示当前命令执行的时间，单位为秒。如果命令发生了重试，则系统会清零后重新计算。

      * `State`：表示该会话当前的状态。

      * `Info`：表示该会话正在执行的语句。

   * 通过直连方式或 ODP 连接数据库时，使用 `SHOW FULL PROCESSLIST` 语句查看租户会话

      ```sql
      SHOW FULL PROCESSLIST;
      ```

      查询结果如下：

      ```shell
      +------------+------+-----------+----------------------+------+---------+------+--------+-----------------------+----------------+------+
      | ID         | USER | TENANT    | HOST                 | DB   | COMMAND | TIME | STATE  | INFO                  | IP             | PORT |
      +------------+------+-----------+----------------------+------+---------+------+--------+-----------------------+----------------+------+
      | 3221926974 | SYS  | oracle001 | xx.xx.xx.xx:36950    | SYS  | Sleep   | 9154 | SLEEP  | NULL                  | xx.xx.xx.197   | 2881 |
      | 3221549774 | SYS  | oracle001 | xx.xx.xx.xx:16924    | SYS  | Query   |    0 | ACTIVE | SHOW FULL PROCESSLIST | xx.xx.xx.198   | 2881 |
      +------------+------+-----------+----------------------+------+---------+------+--------+-----------------------+----------------+------+
      2 rows in set
      ```

      相关字段说明如下：

      * `ID`：表示该会话的 ID。

      * `USER`：表示该会话所属的用户。

      * `TENANT`：表示该会话所访问的租户名称。

      * `HOST`：表示发起该会话的客户端 IP 及端口号。如果您是通过 ODP 连接的数据库，则表示 ODP 的主机 IP 及端口号。

      * `DB`：表示该会话当前连接的数据库名。Oracle 模式显示为与用户名同名的 Schema 名。

      * `COMMAND`：表示该会话正在执行的命令类型。

      * `TIME`：表示当前命令执行的时间，单位为秒。如果命令发生了重试，则系统会清零后重新计算。

      * `STATE`：表示该会话当前的状态。

      * `INFO`：表示该会话执行的语句。

      * `IP`：表示该会话所属的服务器 IP 地址，即 OBServer 节点的 IP 地址。

      * `PORT`：表示该会话所属的服务器的 SQL 端口号，即 OBServer 节点的 SQL 端口号。

## 相关文档

* [终止租户会话](../1200.database-proxy/1600.terminate-a-tenant-session.md)

* [设置租户最大连接数](../1200.database-proxy/1700.set-the-maximum-connections.md)
