|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# 监控索引

OceanBase 数据库提供索引监控功能，并且可以使用视图 `DBA_INDEX_USAGE` 来查询索引监控结果。通过使用这个视图，我们能够更清晰地了解索引的使用情况。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>非用户租户的索引使用不在统计范围，视图 <code>DBA_INDEX_USAGE</code> 仅展示用户租户数据。</p>
</main>

## 注意事项

因为索引监控在集群启动时采用默认的采样（`SAMPLED`）模式，这种模式下并非所有索引使用数据都会被记录到内部表，视图 `DBA_INDEX_USAGE` 可能出现查询结果为空的情况。如果需要准确的信息，可以在当前租户下将监控索引信息收集模式设置为 `ALL`。

可以使用以下 SQL 语句来查看配置型 `_iut_stat_collection_type` 的值：

```sql
SELECT name, data_type, value FROM sys.GV$OB_PARAMETERS WHERE name LIKE '%iut_stat_collection%';
```

使用以下 SQL 语句来设置监控索引信息收集模式：

```sql
ALTER SYSTEM SET "_iut_stat_collection_type"='ALL';
```

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>设置租户级配置项 <code>_iut_stat_collection_type=ALL</code> 模式可能会导致索引查询性能的一定程度下降。因此，在使用该模式时需要谨慎考虑，并权衡性能回退的影响。</p>
</main>

## 示例

1. 创建表 `tbl1`。

    ```sql
    CREATE TABLE tbl1 (col1 NUMBER PRIMARY KEY, col2 VARCHAR(50) NOT NULL, col3 NUMBER);
    ```

2. 在表 `tbl1` 的列 `col3` 上创建了一个名为 `idx1_tbl1` 的索引。

    ```sql
    CREATE INDEX idx1_tbl1 ON tbl1(col3);
    ```

3. 向表 `test_tbl1` 中插入 `5` 条数据。

    ```sql
    INSERT INTO tbl1 VALUES (1, 'name1', 20),(2, 'name2', 19),(3, 'name3', 20),(4, 'name4', 29),(5, 'name5', 26);
    ```

    返回结果如下：

    ```shell
    Query OK, 5 rows affected
    Records: 5  Duplicates: 0  Warnings: 0
    ```

4. 执行 `COMMIT;`。

5. 执行 `SELECT` 查询。

    ```sql
    SELECT col1, col2 FROM tbl1 WHERE col3 >= 25;
    ```

    返回结果如下：

    ```shell
    +------+-------+
    | COL1 | COL2  |
    +------+-------+
    |    5 | name5 |
    |    4 | name4 |
    +------+-------+
    2 rows in set
    ```

6. 查看视图 `DBA_INDEX_USAGE`。

    ```sql
    SELECT OBJECT_ID, NAME, OWNER, TOTAL_ACCESS_COUNT, TOTAL_EXEC_COUNT, LAST_USED FROM sys.DBA_INDEX_USAGE;
    ```

    返回结果如下：

    ```shell
    Empty set
    ```

    默认 `SAMPLED` 模式下，并非所有索引使用数据都会被记录到内部表，可能在视图中查询不到预期的监控结果。可以通过 SQL 语句修改为非采样模式来收集数据，例如以下操作：

    1. 使用以下 SQL 语句来设置监控索引信息收集模式为 `ALL`。

       ```sql
       ALTER SYSTEM SET "_iut_stat_collection_type"='ALL';
       ```

    2. 再次执行 `SELECT` 查询。

       ```sql
       SELECT col1, col2 FROM tbl1 WHERE col3 >= 25;
       ```

    3. 再次查看视图 `DBA_INDEX_USAGE`。

       <main id="notice" type='explain'>
         <h4>说明</h4>
         <p>索引监控在收集统计信息后，通过后台定时任务把数据刷到内部表，可能最长需要等待 15 分钟，才能在视图中查询到索引使用的监控结果。</p>
       </main>

       ```sql
       SELECT OBJECT_ID, NAME, OWNER, TOTAL_ACCESS_COUNT, TOTAL_EXEC_COUNT, LAST_USED FROM sys.DBA_INDEX_USAGE;
       ```

       返回结果如下：

       ```shell
       +-----------+------------------------+-------+--------------------+------------------+------------------------------+
       | OBJECT_ID | NAME                   | OWNER | TOTAL_ACCESS_COUNT | TOTAL_EXEC_COUNT | LAST_USED                    |
       +-----------+------------------------+-------+--------------------+------------------+------------------------------+
       |    500269 | __idx_500266_IDX1_TBL1 | SYS   |                  1 |                1 | 24-JAN-24 02.28.38.264523 PM |
       +-----------+------------------------+-------+--------------------+------------------+------------------------------+
       1 row in set
       ```

       **查询结果说明：**

       `TOTAL_ACCESS_COUNT` 字段说明了 `SELECT` 操作时，`SYS` Schema 下名为 `idx1_tbl1`（`__idx_500266_IDX1_TBL1`）的索引被访问了 `1` 次，最后被访问的时间点为 `24-JAN-24 02.28.38.264523 PM`。

       **字段说明如下：**

       * `OBJECT_ID`：索引表 ID。
       * `NAME`：索引表名。
       * `OWNER`：数据库名。
       * `TOTAL_ACCESS_COUNT`：总共访问次数。
       * `TOTAL_EXEC_COUNT`：总共执行次数。
       * `LAST_USED`：索引表最后一次被使用的时间。

       <!--更多有关视图 `DBA_INDEX_USAGE` 字段的详细信息，请参见 [DBA_INDEX_USAGE](待添加)。-->

## 相关文档

* [创建表](../100.manage-tables-of-oracle-mode/200.create-a-table-for-oracle-tenant-of-oracle-mode.md)
* [创建索引](200.create-an-index-of-oracle-mode.md)
* [删除索引](400.delete-an-index-of-oracle-mode.md)
