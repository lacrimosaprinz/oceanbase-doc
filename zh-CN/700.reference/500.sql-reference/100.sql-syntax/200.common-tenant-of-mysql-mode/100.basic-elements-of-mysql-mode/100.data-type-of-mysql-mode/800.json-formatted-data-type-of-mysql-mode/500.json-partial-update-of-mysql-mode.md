| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | MySQL Mode      |

# Json 部分数据的更新

OceanBase 数据库支持对 Json 部分数据的更新（Json Partial Update）。当只需修改 Json 文档中的特定字段时，该特性允许仅更新所更改的部分，而无需全量更新整个 Json 文档。

## Json Partial Update 开关

OceanBase 数据库的 Json Partial Update 功能默认是不开启的，开关由配置型 `log_row_value_options` 控制，详细信息，参见 [log_row_value_options](../../../../../../800.configuration-items-and-system-variables/200.system-variable/300.global-system-variable/3500.log_row_value_options-global.md)。

**示例如下：**

```sql
// session
set log_row_value_options="partial_json";  
// global
set global log_row_value_options="partial_json";
```

如果想要关闭，则将log_row_value_options置空，即可。

```sql
// session
set log_row_value_options="";
// global
set global log_row_value_options="partial_json";
```

查询

```sql
show variables like 'log_row_value_options';
```

## 可用于 Partial Update 的 Json 表达式

除了 Json Partial Update 功能开关 `log_row_value_options` 外，还需要使用特定的表达式更新 Json 文档，才能触发 Json Partail Update。

当前 OceanBase 数据库 MySQL 模式可以进行 Partial Update 的 Json 表达式如下：

* json_set 或 json_replace：用于更新 Json 字段的值。
* json_remove：用于删除 Json 字段。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>需要保证 <code>SET</code> 赋值子句的左操作数和 Json 表达式的第一个参数是相同的，例如 <code>j = json_replace(j, '$.name', 'ab')</code>，等号左边的参数和等号右边 Json 表达式 <code>json_replace</code> 的第一个参数都是 <code>j</code>。</p>
</main>

**示例如下：**

1. 创建表 `json_test`。

    ```sql
    CREATE TABLE json_test(pk INT PRIMARY KEY, j JSON);
    ```

2. 插入数据。

    ```sql
    INSERT INTO json_test VALUES(1, CONCAT('{"name": "John", "content": "', repeat('x',8), '"}'));
    ```

    返回结果如下：

    ```shell
    Query OK, 1 row affected
    ```

3. 查询 `j` 列的数据。

    ```sql
    SELECT j FROM json_test;
    ```

    返回结果如下：

    ```shell
    +-----------------------------------------+
    | j                                       |
    +-----------------------------------------+
    | {"name": "John", "content": "xxxxxxxx"} |
    +-----------------------------------------+
    1 row in set
    ```

4. 使用 `json_repalce` 更新 `name` 字段的值。

    ```sql
    UPDATE json_test SET j = json_replace(j, '$.name', 'ab') WHERE pk = 1;
    ```

    返回结果如下：

    ```shell
    Query OK, 1 row affected
    Rows matched: 1  Changed: 1  Warnings: 0
    ```

5. 查询 `j` 列修改后的数据。

    ```sql
    SELECT j FROM json_test;
    ```

    返回结果如下：

    ```shell
    +---------------------------------------+
    | j                                     |
    +---------------------------------------+
    | {"name": "ab", "content": "xxxxxxxx"} |
    +---------------------------------------+
    1 row in set
    ```

6. 使用 `json_set` 更新 `name` 字段的值。

    ```sql
    UPDATE json_test SET j = json_set(j, '$.name', 'cd') WHERE pk = 1;
    ```

    返回结果如下：

    ```shell
    Query OK, 1 row affected
    Rows matched: 1  Changed: 1  Warnings: 0
    ```

7. 查询 `j` 列修改后的数据。

    ```sql
    SELECT j FROM json_test;
    ```

    返回结果如下：

    ```shell
    +---------------------------------------+
    | j                                     |
    +---------------------------------------+
    | {"name": "cd", "content": "xxxxxxxx"} |
    +---------------------------------------+
    1 row in set
    ```

8. 使用 `json_remove` 删除 `name` 字段值。

    ```sql
    UPDATE json_test SET j = json_remove(j, '$.name') WHERE pk = 1;
    ```

    返回结果如下：

    ```shell
    Query OK, 1 row affected
    Rows matched: 1  Changed: 1  Warnings: 0
    ```

9. 查询 `j` 列修改后的数据。

    ```sql
    SELECT j FROM json_test;
    ```

    返回结果如下：

    ```shell
    +-------------------------+
    | j                       |
    +-------------------------+
    | {"content": "xxxxxxxx"} |
    +-------------------------+
    1 row in set
    ```
