| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |

# COVAR_SAMP

## 描述

该函数用于计算一组数值对的样本协方差。可以将该函数用作聚合或分析函数。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <ul>
    <li>作为分析函数使用时，需要使用 <code>OVER</code> 子句定义窗口进行计算。它对一组行的集合进行计算并返回多个值。</li>
    <li>作为聚合函数使用时，该函数对一组行的集合进行聚合计算，结果只能返回一个值，此时不需要加 <code>OVER</code> 子句。</li>
    </ul>
  </main>

## 语法

```sql
COVAR_SAMP(expr1, expr2) [ OVER (analytic_clause) ]
```

## 参数解释

|  参数   |                                           说明                                            |
|-------|-----------------------------------------------------------------------------------------|
| expr1 | 指定第一个数值表达式，属于数值数据类型或可以隐式转换为数值数据类型的值。                                                    |
| expr2 | 指定第二个数值表达式，属于数值数据类型或可以隐式转换为数值数据类型的值。                                                    |
| OVER  | 使用 `OVER` 子句定义窗口进行计算。详细信息请参见 [分析函数说明](../400.analysis-functions-of-oracle-mode/100.window-function-description-of-oracle-mode.md)。 |

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <ul>
    <li>数据库确定具有最高数值优先级的参数，将其余参数隐式转换为该数据类型，并返回该数据类型。</li>
    <li>参数 <code>expr1</code> 和 <code>expr2</code> 的位置不影响返回结果，即 <code>COVAR_POP(expr1, expr2)</code> 等于 <code>COVAR_POP(expr2, expr1)</code>。</li>
    <li>返回结果计算公式为：<code>(SUM(expr1 * expr2) - SUM(expr1) * SUM(expr2) / n) / (n-1)</code>，其中 <code>n</code> 是（<code>expr1</code>,<code>expr2</code>）表达式对的数量，<code>expr1</code> 和 <code>expr2</code> 均不为空。</li>
    </ul>
  </main>

## 返回类型

如果有任意一个参数为空或只有一行数据，则返回 `NULL`；否则返回一个 `NUMBER` 类型的值。

## 示例

现有已创建的表 `tbl1`。

```sql
obclient> SELECT * FROM tbl1;
+------+------+------+------+
| COL1 | COL2 | COL3 | COL4 |
+------+------+------+------+
|    1 | A1   |    8 |   12 |
|    1 | A2   |   10 |   15 |
|    1 | A3   |   11 |   16 |
|    2 | B1   |    9 |   14 |
|    2 | B2   |   10 |   15 |
|    2 | B3   |    8 |   13 |
|    2 | B4   |   11 |   16 |
|    3 | C1   |    8 |   18 |
|    3 | C2   |    9 |   16 |
|    3 | C3   |   10 |   15 |
|    3 | C4   |   11 |   12 |
|    3 | C5   |   12 |   10 |
+------+------+------+------+
12 rows in set
```

### 聚合函数示例

计算数值对列 `col3` 与列 `col4` 的样本协方差。

```sql
obclient> SELECT COVAR_SAMP(col3,col4) FROM tbl1;
+--------------------------------------------+
| CORR(COL3,COL4)                            |
+--------------------------------------------+
| -.2705008904002296868793073195758520224002 |
+--------------------------------------------+
1 row in set
```

### 分析函数示例

按列 `col1` 分组和列 col2 排序，计算数值对列 `col3` 的数据与列 `col4` 的累计样本协方差。

```sql
obclient> SELECT col1,col3,col4,
            COVAR_SAMP(col3,col4) OVER(PARTITION BY col1 ORDER BY col2) "COVAR_SAMP"
          FROM tbl1;
+------+------+------+-------------------------------------------+
| COL1 | COL3 | COL4 | COVAR_SAMP                                |
+------+------+------+-------------------------------------------+
|    1 |    8 |   12 |                                      NULL |
|    1 |   10 |   15 |                                         3 |
|    1 |   11 |   16 |   3.1666666666666666666666666666666666665 |
|    2 |    9 |   14 |                                      NULL |
|    2 |   10 |   15 |                                        .5 |
|    2 |    8 |   13 |                                         1 |
|    2 |   11 |   16 |  1.66666666666666666666666666666666666667 |
|    3 |    8 |   18 |                                      NULL |
|    3 |    9 |   16 |                                        -1 |
|    3 |   10 |   15 |                                      -1.5 |
|    3 |   11 |   12 | -3.16666666666666666666666666666666666667 |
|    3 |   12 |   10 |                                        -5 |
+------+------+------+-------------------------------------------+
12 rows in set
```
