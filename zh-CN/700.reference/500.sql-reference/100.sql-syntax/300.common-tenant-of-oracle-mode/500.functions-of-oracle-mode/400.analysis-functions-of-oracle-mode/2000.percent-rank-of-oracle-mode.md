| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |

# PERCENT_RANK

## 描述

该函数用来计算一组值中的某个值的累积分布。类似于 `CUME_DIST` 函数。可以将此函数用作聚合或分析函数。

* 作为聚合函数，`PERCENT_RANK` 计算某一个数在一个集合中的对应位置百分比，它的返回值范围为 (0, 1\]。如果有 `N` 行数据，`expr` 的值，大于第二行的值而小于第三行的值，那么位置百分比等于 `2/N`。常量参数表达式和 `ORDER BY` 聚合子句中的表达式按位置匹配。因此，参数的数量必须相同，并且它们的类型必须兼容。如果指定值与分组序列中某值重复，则将两个相同的值视为一个值处理。

* 作为分析函数，`PERCENT_RANK` 计算某列或某列组合后每行的百分比排序，它的返回值范围为 \[0, 1\]。当有相同排序值时，将会有相同的排名，并且值相同的行数会被记录到下个排名中。任何集合中的第一行的 `PERCENT_RANK` 函数为 `0`，位置百分比的计算公式为：位置百分比=序号/最大序号，具体示例请参见如下表格：

  | N | 序号 | 位置百分比 |
  |---|----|-------|
  | A | 0  | 0     |
  | B | 1  | 0.25  |
  | C | 2  | 0.5   |
  | D | 3  | 0.75  |
  | E | 4  | 1     |

## 语法

```sql
/*聚合语法*/
PERCENT_RANK(expr [, expr ...]) WITHIN GROUP
               ( ORDER BY expr_col [ DESC | ASC ][ NULLS { FIRST | LAST } ]
                          [,expr_col [ DESC | ASC ][ NULLS { FIRST | LAST } ]]...
               )

/*分析语法*/
PERCENT_RANK( ) OVER ([query_partition_clause] order_by_clause)
```

## 参数解释

|           参数            |                                                                                                            说明                                                                                                            |
|-------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| expr                    | 指定要查询的值。                                                                                                                                                                                                                 |
| expr_col                | 指定要查询的值对应的列名。                                                                                                                                                                                                            |
| DESC \| ASC             | 指定列表的排序方式，为可选项。 <ul><li> `ASC` 为升序排序，为默认值。   </li><li> `DESC` 为降序排序。  </li></ul>                                                               |
| NULLS { FIRST \| LAST } | 排序后 `expr_col` 中 `NULL` 值的位置，为可选项。 <ul><li> `NULLS FIRST` 表示 `NULL` 值排在非空值的前面。   </li><li> `NULLS LAST` 表示 `NULL` 值排在非空值的后面，为默认值。</li></ul>    |
| OVER                    | 使用 `OVER` 子句定义窗口进行计算。详细信息请参见 [分析函数说明](../400.analysis-functions-of-oracle-mode/100.window-function-description-of-oracle-mode.md)。                                                                                                                                  |

## 返回类型

返回 `NUMBER` 数据类型。

## 示例

现有已创建的表 `emp_msg`。

```sql
obclient> SELECT * FROM emp_msg;
+--------+--------+------+------+
| DEPTNO | ENAME  | SAL  | MGR  |
+--------+--------+------+------+
|     10 | CLARK  | 2750 | 7839 |
|     10 | KING   | 5300 | NULL |
|     10 | MILLER | 1600 | 7782 |
|     20 | ADAMS  | 1400 | 7788 |
|     20 | FORD   | 3300 | 7566 |
|     20 | JONES  | 3275 | 7839 |
|     20 | SCOTT  | 3300 | 7566 |
|     20 | SMITH  | 1100 | 7902 |
|     30 | ALLEN  | 1900 | 7698 |
|     30 | BLAKE  | 3150 | 7839 |
|     30 | JAMES  | 1250 | 7698 |
|     30 | MARTIN | 1550 | 7698 |
|     30 | TURNER | 1800 | 7698 |
|     30 | WARD   | 1550 | 7698 |
|     30 | SCLARK | 1750 | 7839 |
+--------+--------+------+------+
15 rows in set
```

### 聚合函数示例

返回 `3300` 在列 `sal` 中的位置百分比。

```sql
obclient> SELECT PERCENT_RANK(3300) WITHIN GROUP (ORDER BY sal) FROM emp_msg;
+-------------------------------------------+
| PERCENT_RANK(3300)WITHINGROUP(ORDERBYSAL) |
+-------------------------------------------+
|                                        .8 |
+-------------------------------------------+
1 row in set
```

### 分析函数示例

以列 `deptno` 分组和列 `sal` 降序排序并返回列 `sal` 中各值的位置百分比。

```sql
obclient> SELECT deptno,ename,sal,
              PERCENT_RANK() OVER (PARTITION BY deptno ORDER BY sal DESC) AS pr1
          FROM emp_msg;
+--------+--------+------+-------------------------------------------+
| DEPTNO | ENAME  | SAL  | PR1                                       |
+--------+--------+------+-------------------------------------------+
|     10 | KING   | 5300 |                                         0 |
|     10 | CLARK  | 2750 |                                        .5 |
|     10 | MILLER | 1600 |                                         1 |
|     20 | FORD   | 3300 |                                         0 |
|     20 | SCOTT  | 3300 |                                         0 |
|     20 | JONES  | 3275 |                                        .5 |
|     20 | ADAMS  | 1400 |                                       .75 |
|     20 | SMITH  | 1100 |                                         1 |
|     30 | BLAKE  | 3150 |                                         0 |
|     30 | ALLEN  | 1900 | .1666666666666666666666666666666666666667 |
|     30 | TURNER | 1800 | .3333333333333333333333333333333333333333 |
|     30 | SCLARK | 1750 |                                        .5 |
|     30 | MARTIN | 1550 | .6666666666666666666666666666666666666667 |
|     30 | WARD   | 1550 | .6666666666666666666666666666666666666667 |
|     30 | JAMES  | 1250 |                                         1 |
+--------+--------+------+-------------------------------------------+
15 rows in set
```
