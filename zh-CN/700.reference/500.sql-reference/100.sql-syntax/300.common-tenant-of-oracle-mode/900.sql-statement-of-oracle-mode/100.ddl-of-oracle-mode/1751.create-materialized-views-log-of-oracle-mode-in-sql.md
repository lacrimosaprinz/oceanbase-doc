|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|Oracle Mode|

# CREATE MATERIALIZED VIEW LOG

## 描述

该语句用来创建物化视图日志。

物化视图日志（Materialized View Log，mlog）用于记录用户表（基表）的增量更新数据，以支持物化视图的快速刷新功能。`mlog` 是一个记录表，追踪基表的变化，并将这些变化应用于相应的物化视图，实现快速刷新。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>OceanBase 数据库 <code>mlog</code> 暂时不支持指定 Partition，<code>mlog</code> 的 Partition 和基表的 Partition 是绑定关系。</p>
</main>

## 权限要求

创建物化视图日志需要有 `CREATE TABLE` 和基表的 `SELECT` 权限。更多有关 OceanBase 数据库权限的详细介绍，请参见 [Oracle 模式下的权限分类](../../../../../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/300.permission-of-oracle-mode/000.permission-classification-of-oracle-mode.md)。

## 语法

```sql
CREATE MATERIALIZED VIEW LOG ON [schema.] table [parallel_clause] [with_clause] [mv_log_purge_clause];

parallel_clause:
    NOPARALLEL 
    | PARALLEL integer

with_clause:
    WITH [ {PRIMARY KEY | ROWID | SEQUENCE} 
            [ { , PRIMARY KEY | , ROWID | , SEQUENCE }]... ] 
        (column_name [, column_name]...) 
        [new_values_clause]

new_values_clause:
    {INCLUDING | EXCLUDING} NEW VALUES

mv_log_purge_clause:
    PURGE {IMMEDIATE SYNCHRONOUS
        | START WITH datetime_expr [NEXT datetime_expr]
        | [START WITH datetime_expr] NEXT datetime_expr
        }
```

## 参数说明

|       **参数**      |       **描述**           |
|---------------------|--------------------------|
| schema.             | 可选项，指定物化视图日志基表所在的 Schema。如果省略 `schema.`，则默认基表在您自己的 Schema 中。|
| table               | 指定物化视图日志对应的基表名称。|
| parallel_clause     | 可选项，指定创建物化视图表的 dop，即用于指定并行处理物化视图日志的级别。详细介绍可参见下文 [parallel_clause](#parallel_clause)。|
| with_clause         | 可选项，指定物化视图日志中包含的辅助列。用于指示是否记录基表发生变化时的主键（`PRIMARY KEY`）和行标识符（`ROWID`），并且还可以使用该子句添加序列（`SEQUENCE`）来为物化视图日志提供额外的排序信息。详细介绍可参见下文 [with_clause](#with_clause)。|
| column_name         | 可选项，指定要在所有已更改行的物化视图日志中记录其值的列名称。|
| new_values_clause   | 可选项，是否在物化视图日志中同时记录更新操作中的旧值和新值。详细介绍可参见下文 [new_values_clause](#new_values_clause)。|
| mv_log_purge_clause | 可选项，指定物化视图日志中数据的清除时间。详细介绍可参见下文 [mv_log_purge_clause](#mv_log_purge_clause)。|

### parallel_clause

* `NOPARALLEL`：默认配置，并行度为 `1`。

* `PARALLEL integer`：指定并行度，`integer` 取值大于等于 `1`。

### with_clause

* `PRIMARY KEY`：表示物化视图日志记录的是基表的主键列。只能用于有主键的表，如果不指定，则系统会自动选择主键列进行记录。

* `ROWID`：表示物化视图日志记录的是基表的行标识符（`ROWID`）。只能用于无主键的表，如果不指定，则系统会自动使用隐藏的 `ROWID` 进行记录。

* `SEQUENCE`：表示物化视图日志记录的是事务内的多行更新序号（seq_no）。系统会自动为物化视图日志添加这个属性。

### new_values_clause

* `INCLUDING`：默认设置，表示可以在物化视图日志中保存新旧值。如果希望物化视图支持快速刷新，则必须指定 `INCLUDING NEW VALUES`。

* `EXCLUDING`：表示禁用在物化视图日志中记录新值。请不要使用 `EXCLUDING NEW VALUES`，否则将会报错。

### mv_log_purge_clause

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>只有在物化视图成功刷新后，物化视图日志中的相应数据才会被清除。</p>
</main>

* `IMMEDIATE`：表示在每次刷新完物化视图后就立即清除相应的物化视图日志。

  * `SYNCHRONOUS`：表示同步地执行清除。

* `START WITH datetime_expr [NEXT datetime_expr]`：

  * `START WITH datetime_expr`：表示物化视图日志的首次清除时间。
  * `[NEXT datetime_expr]`：可选项，表示下一次清除物化视图日志的时间。 用于设置下一次清除物化视图日志的时间。

* `[START WITH datetime_expr] NEXT datetime_expr`：如果未指定 `START WITH datetime_expr` 参数，仅指定 `NEXT datetime_expr` 参数，那么物化视图日志的第一次清除时间将设定为 `NEXT datetime_expr` 参数的值。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>请确保 <code>START WITH datetime_expr</code> 和 <code>NEXT datetime_expr</code> 这两个时间表达式设定在未来的时间点，否则会引发错误。</p>
</main>

建议使用 `current_date` 表示当前时区时间，时间表达式示例如下：

* 从当前时间（`current_date`）开始，每隔 10 秒清理一次过期的物化视图日志记录。

  ```sql
  START WITH current_date NEXT current_date + INTERVAL '10' SECOND
  ```

* 从当前时间（`current_date`）开始，每隔 10 小时清理一次过期的物化视图日志记录。

  ```sql
  START WITH current_date NEXT current_date + INTERVAL '10' HOUR
  ```

* 表示从当前时间（`current_date`）开始，每隔 1 天清理一次过期的物化视图日志记录。

  ```sql
  START WITH current_date NEXT current_date + 1
  ```

## 示例

1. 创建表 `test_tbl1`。

    ```sql
    CREATE TABLE test_tbl1 (id NUMBER PRIMARY KEY, name VARCHAR2(20), age NUMBER);
    ```

2. 在 `test_tbl1` 表上创建物化视图日志。指定并行处理物化视图日志的并行度为 `5` 和物化视图日志记录 `name` 和 `age` 列的变更信息，并且会记录变更前后的新值；配置物化视图日志从当前日期开始，每隔 `1` 天清理一次过期的物化视图日志记录。

    ```sql
    CREATE MATERIALIZED VIEW LOG ON test_tbl1 
      PARALLEL 5 
      WITH SEQUENCE(name ,age) INCLUDING NEW VALUES
      PURGE START WITH current_date NEXT current_date + 1;
    ```

3. 查看表 `test_tbl1` 上物化视图日志的信息。

    ```sql
    DESC mlog$_test_tbl1;
    ```

    返回结果如下：

    ```shell
    +------------+--------------+------+------+---------+-------+
    | FIELD      | TYPE         | NULL | KEY  | DEFAULT | EXTRA |
    +------------+--------------+------+------+---------+-------+
    | SEQUENCE$$ | BIGINT       | NO   | PRI  | NULL    | NULL  |
    | ID         | NUMBER       | NO   | NULL | NULL    | NULL  |
    | NAME       | VARCHAR2(20) | YES  | NULL | NULL    | NULL  |
    | AGE        | NUMBER       | YES  | NULL | NULL    | NULL  |
    | DMLTYPE$$  | VARCHAR2(1 ) | YES  | NULL | NULL    | NULL  |
    | OLD_NEW$$  | VARCHAR2(1 ) | YES  | NULL | NULL    | NULL  |
    +------------+--------------+------+------+---------+-------+
    6 rows in set
    ```

## 相关文档

* [物化视图日志概述](../../../../../300.database-object-management/200.manage-object-of-oracle-mode/500.manage-views-of-oracle-mode/200.manage-materialized-views-of-oracle-mode/200.materialized-views-log-of-oracle-mode/100.materialized-views-log-overview-of-oracle-mode.md)

* [创建物化视图日志](../../../../../300.database-object-management/200.manage-object-of-oracle-mode/500.manage-views-of-oracle-mode/200.manage-materialized-views-of-oracle-mode/200.materialized-views-log-of-oracle-mode/200.create-materialized-views-log-of-oracle-mode.md)

* [删除物化视图日志](../../../../../300.database-object-management/200.manage-object-of-oracle-mode/500.manage-views-of-oracle-mode/200.manage-materialized-views-of-oracle-mode/200.materialized-views-log-of-oracle-mode/300.delete-materialized-views-log-of-oracle-mode.md)
