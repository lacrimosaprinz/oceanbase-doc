| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |

# 事务处理与控制 

事务处理功能使多个用户可以同时在数据库上工作，并确保每个用户都能看到一致的数据版本，并确保以正确的顺序应用所有更改。

  <main id="notice" >
    <h4>功能适用性</h4>
    <p>该内容仅适用于 OceanBase 数据库企业版。OceanBase 数据库社区版仅提供 MySQL 模式。</p>
  </main>

事务是一个或多个 SQL 语句的序列，OceanBase 数据库将其视为一个单元，即要么执行所有语句，要么都不执行。

由于 OceanBase 数据库自动锁定数据结构，因此不同的用户可以写入相同的数据结构而不会损害彼此的数据。为了最大程度地提高数据可用性，OceanBase 数据库会在最短的时间内锁定最少量的数据。

OceanBase 数据库支持编写额外的代码来防止多个用户同时访问数据的问题，并可以手动覆盖 OceanBase 数据库默认的锁定机制。

PL 所支持的事务处理与控制的语句如下：

* `COMMIT` 语句

  用于结束当前事务，使其更改永久生效，并且对其他用户可见。
  

* `ROLLBACK` 语句

  用于结束当前事务，并撤销在该事务期间所做的任何更改。如果操作失误，例如从表中删除错误的行，则 `ROLLBACK` 将还原原始数据。如果由于 SQL 语句执行失败或 PL 引发异常而无法完成事务，则 `ROLLBACK` 提供了一种纠正措施以重新开始。
  

* `SAVEPOINT` 语句

  用于在事务处理中命名并标记当前点。使用保存点可以回滚事务的一部分而不是整个事务。 每个会话的活动保存点数是无限的。当回滚到保存点时，该保存点之后标记的所有保存点都将被删除。简单的回滚或提交将删除所有保存点。

  保存点名称是未声明的标识符。在事务中重用保存点名称会将保存点从旧位置移动到事务中的当前点。
  

* `SET TRANSACTION` 语句

  用于开始只读或读写事务，建立隔离级别或将当前事务分配给指定的回滚段。

  只读事务对于多用户更新相同表并运行多个查询的场景很有用。在只读事务期间，所有查询都引用数据库的同一快照，从而提供多表、多查询、读取一致的视图。其他用户可以照常继续查询或更新数据。提交或回滚将结束事务。

  `SET TRANSACTION` 语句必须是只读事务中的第一个 SQL 语句，并且在事务中只能出现一次。如果将事务设置为 `READ ONLY`，则后续查询将仅查看在事务开始之前提交的更改，并且不会影响其他用户或事务。

  只读事务中仅允许使用 `SELECT`、`OPEN`、`FETCH`、`CLOSE`、`LOCK TABLE`、`COMMIT` 和`ROLLBACK` 语句。查询不能使用 `FOR UPDATE`。
  




此外，在运行 `INSERT`、`UPDATE`、`DELETE` 或 `MERGE` 语句之前，数据库会标记一个隐式保存点（不可用）。如果该语句失败，则数据库将回滚到保存点。通常，只回退失败的 SQL 语句，而不回退整个事务。如果该语句引发未处理的异常，则主机环境将确定要回滚的内容。数据库还可以回滚单个 SQL 语句以打破死锁。数据库向参与事务发送错误信号，并回滚该事务中的当前语句。在运行 SQL 语句之前，必须由数据库进行解析，即检查并确保其遵循语法规则并引用有效的 Schema 对象。运行 SQL 语句时检测到的错误会导致回滚，但解析该语句时检测到的错误不会。如果退出带有未处理异常的存储子程序，则 PL 不会将值分配给 `OUT` 参数，并且不会进行任何回滚。
